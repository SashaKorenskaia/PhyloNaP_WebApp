{% extends "base.html" %}
{% block content %}

<head>
  <!-- Your existing head content... -->
  <!-- Latest compiled and minified CSS -->
  <script src="https://code.jquery.com/jquery.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>

  <!-- <link
        rel="stylesheet"
        href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
        crossorigin="anonymous"
      /> -->
  {% block css %}
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet" />
  <link href="/static/js/phylotree.css" rel="stylesheet" />
  <link href="/static/js/overall.css" rel="stylesheet" />
  {% endblock %}

  <!-- Optional theme -->
  <!-- <link
        rel="stylesheet"
        href="//stackpath.bootstrapcdn.com/bootswatch/4.1.1/spacelab/bootstrap.min.css"
      /> -->
  <!-- Latest compiled and minified JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/split.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
    integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"
    defer></script>
  <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
    integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"
    defer></script>

  <script src="//d3js.org/d3.v6.js" defer></script>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <!-- <script src="/static/js/phylotree.js/dist/phylotree.js" defer></script> -->
  <script src="/static/js/phylotree.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }

    * {
      margin: 0;
      padding: 0;
    }

    body,
    html {
      /* background-color: #D8BFD8; */
    }

    .layout {
      display: flex;
      width: 100%;
      /* Use full viewport width */
      height: 100vh;
      /* Use full viewport height */
    }

    .tree-panel {
      display: flex;
      flex-direction: column;
      flex: 4;
      /* Take up 1 part of the available space */
      /* background-color: #fff;  */
      /* White background */
      /* overflow: auto; */
      margin: 0;
      padding: 0;
    }

    .tree-controls {
      flex-shrink: 0;
      /* background-color: peachpuff;  */
      /* White background */
      height: 30px;
      /* overflow: auto; */
    }

    .tree {
      height: calc(100% - 50px);
      width: 100% !important;
      flex-grow: 1;
      /* background-color: beige; */
      /* overflow: auto; */
      /* margin: 0;
      padding: 0; */
      overflow: auto;
    }

    .details {
      flex: 1;
      /* Take up 2 parts of the available space */
      /* background-color: #D1E7E0; 
      Grey background */
      /* background-color: #CCDDE2; */
      /* background-color:#6BA292; */
      background-color: #e8e4d8;
      overflow: auto;
      /* Add scrollbars if necessary */
      margin: 0;
      /* Remove all margins */
      padding: 0;
      /* Remove all padding */
      box-sizing: border-box;
      /* Include padding in the element's total width and height */
    }

    .details>div {
      display: flex;
      justify-content: flex-end;
    }

    .details>div>div {
      padding: 10px;
      margin-top: 1rem;
      width: 100%;
      /* Ensure the inner content takes the full width */
    }

    .details h3,
    .details h10,
    .details h4 {
      margin: 0;
      /* Remove default margins */
    }

    /* .collapsible {
      height: 4em;
      overflow: hidden;
      position: relative;
    } */
    /* .collapsible::after {
      content: "...";
      position: absolute;
      bottom: 0;
      right: 0;
      background: white;
      padding-left: 1em;
    } */
    #enlarged-image-container {
      position: relative;
      width: 100%;
      /* Adjust as needed */
      max-width: 100%;
      max-height: 100%;
    }

    /* #enlarged-image-container {
      position: fixed;
      right: -140px;
      top: 80%;
      transform: translateY(-50%);
      width: 50%; 
      max-width: 100%;
      max-height: 100%;
    } */

    #enlarged-image {
      width: 100%;
      height: 100%;
      max-width: 100%;
      max-height: 100%;
    }

    .no-overlap {
      position: relative;
      z-index: 1;
    }

    #tree-container {
      width: 100%;
      height: 100%;
      /* Adjust this value as needed */

      /* Add scrollbars if the content is larger than the container */
      /* overflow: auto;  */

    }

    #tree_name {
      /* Remove the !important and let JavaScript control the font size */
      font-size: 1.75rem;
    }

    /* Add a class for JavaScript-controlled sizing */
    #tree_name.js-resized {
      font-size: var(--js-font-size) !important;
    }
  </style>
</head>

<div class="layout">
  <div class="tree-panel">
    <div class="tree-controls">
      <div class="d-flex align-items-center justify-content-between">
        <div class="btn-group" role="group">
          <button type="button" class="btn btn-light btn-sm" data-direction="vertical" data-amount="1"
            title="Expand vertical spacing">
            <i class="fa fa-arrows-v"></i>
          </button>
          <button type="button" class="btn btn-light btn-sm" data-direction="vertical" data-amount="-1"
            title="Compress vertical spacing">
            <i class="fa  fa-compress fa-rotate-135"></i>
          </button>
          <button type="button" class="btn btn-light btn-sm" data-direction="horizontal" data-amount="1"
            title="Expand horizonal spacing">
            <i class="fa fa-arrows-h"></i>
          </button>
          <button type="button" class="btn btn-light btn-sm" data-direction="horizontal" data-amount="-1"
            title="Compress horizonal spacing">
            <i class="fa  fa-compress fa-rotate-45"></i>
          </button>
          <!-- <button
        type="button"
        class="btn btn-light btn-sm"
        id="sort_ascending"
        title="Sort deepest clades to the bototm"
      >
        <i class="fa fa-sort-amount-asc"></i>
      </button>
      <button
        type="button"
        class="btn btn-light btn-sm"
        id="sort_descending"
        title="Sort deepsest clades to the top"
      >
        <i class="fa fa-sort-amount-desc"></i>
      </button>
      <button
        type="button"
        class="btn btn-light btn-sm"
        id="sort_original"
        title="Restore original order"
      >
        <i class="fa fa-sort"></i>
      </button> -->
          <button type="button" class="btn btn-light btn-sm" id="save_image" title="Save image"><i
              class="fa fa-picture-o"></i>
          </button>
          <button class="btn btn-light btn-sm active phylotree-align-toggler" data-align="left">
            <i class="fa fa-align-left"></i>
          </button>
          <button class="btn btn-light btn-sm phylotree-align-toggler" data-align="right">
            <i class="fa fa-align-right"></i>
          </button>

        </div>
        <!-- <button
      class="btn btn-light btn-sm phylotree-align-toggler"
      id="midpoint-root-btn"
    >
      Root at Midpoint
    </button> -->
      </div>
    </div>


    <!-- 
    <div id="tree"></div>
    <div id="tree-container" nwk_data="{{ nwk_data }}"></div>
    <div id="metadata-container" metadata="{{ metadata }}"></div> -->
    <!-- <div id="tree_data" style="margin-top: 20%;" nwk_data="{{ nwk_data }}" metadata="{{ metadata }}" metadata_list="{{ metadata_list }}" datasetDescr="{{ datasetDescr }}"></div> -->
    <div class="tree" id="tree">
      <div id="tree_data" nwk_data="{{ nwk_data }}" metadata="{{ metadata }}" metadata_list="{{ metadata_list }}"
        datasetDescr="{{ datasetDescr }}" source="{{ source }}" cite="{{ cite }}"></div>
    </div>
  </div>
  <div class="details">
    <!-- <div class="d-flex justify-content-end"> -->
    <div style="display: flex; justify-content: flex-end;">
      <div style="padding: 10px; margin-top: 1rem; "> <!-- Add background color, padding and top margin -->
        <div style="display: flex; justify-content: center;">
          <div style="display: flex; justify-content: center;">
            <h3 id="tree_name">{{ superfamily_name }}{% if source == 'curated' %} - {{ dataset_name }}{% endif %}</h3>
          </div>
        </div>
        <h10 id="description">The descripton of the treeThe descripton of the treeThe descripton of the treeThe
          descripton of the tree</h10>
        {% if source == 'curated' and cite %}
        <div id="cite"
          style="margin-top: 15px; padding: 12px; background-color: #f8f9fa; border-left: 4px solid #3D3D3D; border-radius: 4px;">
          <h5 style="color: #495057; margin-bottom: 8px; font-weight: 600;">
            <i class="fa fa-quote-left" style="margin-right: 5px; color: #3D3D3D; font-size: 12px;"></i>
            Citation
          </h5>
          <div style="margin-left: 15px; font-size: 14px; line-height: 1.4;">
            {% if cite.name %}
            <div style="margin-bottom: 6px;">
              <span style="font-weight: 500; color: #495057;">Authors:</span>
              <span style="color: #6c757d;">{{ cite.name }}</span>
            </div>
            {% endif %}
            {% if cite.doi %}
            <div>
              <span style="font-weight: 500; color: #495057;">DOI:</span>
              {% if cite.doi.startswith('DOI: ') %}
              <a href="https://doi.org/{{ cite.doi[5:] }}" target="_blank"
                style="color: #3D3D3D; text-decoration: underline; font-weight: 500; transition: color 0.2s;"
                onmouseover="this.style.color='#555555'" onmouseout="this.style.color='#3D3D3D'">
                {{ cite.doi }}
                <i class="fa fa-external-link" style="margin-left: 4px; font-size: 10px;"></i>
              </a>
              {% elif cite.doi.startswith('http') %}
              <a href="{{ cite.doi }}" target="_blank"
                style="color: #3D3D3D; text-decoration: underline; font-weight: 500; transition: color 0.2s;"
                onmouseover="this.style.color='#555555'" onmouseout="this.style.color='#3D3D3D'">
                {{ cite.doi }}
                <i class="fa fa-external-link" style="margin-left: 4px; font-size: 10px;"></i>
              </a>
              {% else %}
              <a href="{{ cite.doi }}" target="_blank"
                style="color: #3D3D3D; text-decoration: underline; font-weight: 500; transition: color 0.2s;"
                onmouseover="this.style.color='#555555'" onmouseout="this.style.color='#3D3D3D'">
                DOI: {{ cite.doi }}
                <i class="fa fa-external-link" style="margin-left: 4px; font-size: 10px;"></i>
              </a>
              {% endif %}
            </div>
            {% endif %}
          </div>
        </div>
        {% endif %}

        <div id="button-container">
          <h4>Annotation</h4>
          <script>
            const color_buttons = "#982B1C";
            const color_old = "#a61e37";
          </script>

          <script>
            var datasetDescr = document.getElementById('tree_data').getAttribute('datasetDescr');
            document.getElementById('description').textContent = datasetDescr;

            var metadataList = document.getElementById('tree_data').getAttribute('metadata_list');
            metadataList = metadataList.replace(/'/g, '"');
            var metadataListArray = JSON.parse(metadataList);

            var buttonContainer = document.getElementById('button-container');

            metadataListArray.forEach(function (item) {
              var button = document.createElement('button');
              button.id = item;
              // button.style.backgroundColor = '#a61e37';
              // button.style.color = 'white';
              button.className = 'btn m-1 non-active-button';
              button.textContent = item.replace('_', ' ');

              buttonContainer.appendChild(button);
            });
          </script>
        </div>
        <!-- {{ metadata_list }} 
        {% for item in metadataListArray %}
            <button id="{{ item }}" class="btn m-1" style="background-color: #a61e37; color: white;">{{ item.replace('_', ' ') }}</button>
        {% endfor %} -->
        <!-- <button id="Enzyme_function" class="btn m-1" style="background-color: #982B1C; color: white;">Enzyme Function</button>
        <button id="Species" class="btn m-1" style="background-color: #982B1C; color: white;">Species</button>
        <button id="biosyn_class" class="btn m-1" style="background-color: #982B1C; color: white;">BGC type</button> -->
        <h4>Structures</h4>
        <button id="BGC_product" class="btn m-1 non-active-button">BGC product</button>
        <button id="Reaction" class="btn m-1 non-active-button">Reaction</button>
        <h4>Metadata summary</h4>
        <div id="summary-container"></div>
        <h4>Placements</h4>
        <div id="placement-container"></div>
      </div>

    </div>

    <div id="enlarged-image-container">
      <!-- <img id="enlarged-image" src="" alt="Enlarged image" /> -->
      <img id="enlarged-image" src="" />
    </div>
  </div>

</div>







<script>
  const content = "{{ content }}";
  console.log("phylotree_render.html content:");
  console.log(content);
</script>
<script src="static/js/tree_general.js"></script>
<script src="static/js/tree_placement.js"></script>
<!-- <script src="static/js/tree_rendering.js"></script> -->

<script>
  // Function to adjust tree name font size based on number of lines
  function adjustTreeNameFontSize() {
    const treeNameElement = document.getElementById('tree_name');
    if (!treeNameElement) {
      console.log('Tree name element not found');
      return;
    }

    // Reset to default size first
    treeNameElement.classList.remove('js-resized');
    treeNameElement.style.removeProperty('--js-font-size');

    // Force a reflow to get accurate measurements
    treeNameElement.offsetHeight;

    // Get the element's dimensions
    const elementHeight = treeNameElement.offsetHeight;
    const computedStyle = window.getComputedStyle(treeNameElement);
    const lineHeight = parseFloat(computedStyle.lineHeight);
    const fontSize = parseFloat(computedStyle.fontSize);

    // Try different line height calculations
    const calculatedLines1 = Math.round(elementHeight / lineHeight);
    const calculatedLines2 = Math.round(elementHeight / fontSize);
    const calculatedLines3 = Math.round(elementHeight / (fontSize * 1.2)); // Default line-height multiplier

    console.log(`Tree name detailed measurement:`, {
      elementHeight,
      lineHeight,
      fontSize,
      calculatedLines1: calculatedLines1,
      calculatedLines2: calculatedLines2,
      calculatedLines3: calculatedLines3,
      textContent: treeNameElement.textContent,
      textLength: treeNameElement.textContent.length
    });

    // Use a more reliable line count method
    let numberOfLines;
    if (lineHeight === fontSize) {
      // Line height not explicitly set, use font size
      numberOfLines = Math.round(elementHeight / (fontSize * 1.2));
    } else {
      numberOfLines = Math.round(elementHeight / lineHeight);
    }

    console.log(`Final calculated lines: ${numberOfLines}`);

    // Alternative method: use character count as fallback
    const textLength = treeNameElement.textContent.length;
    const containerWidth = treeNameElement.offsetWidth;

    console.log(`Container width: ${containerWidth}, Text length: ${textLength}`);

    // If calculations seem wrong, use character-based estimation
    if (numberOfLines <= 1 && textLength > 50) {
      // Estimate based on character count and container width
      const avgCharWidth = fontSize * 0.6; // Rough estimate
      const charsPerLine = Math.floor(containerWidth / avgCharWidth);
      numberOfLines = Math.ceil(textLength / charsPerLine);
      console.log(`Using character-based estimation: ${numberOfLines} lines (${charsPerLine} chars per line)`);
    }

    // If more than 3 lines, aggressively reduce font size
    if (numberOfLines > 3) {
      console.log(`Tree name has ${numberOfLines} lines, adjusting font size...`);
      let newFontSize;

      if (numberOfLines === 4) {
        newFontSize = '16px';  // Much smaller - regular text size
      } else if (numberOfLines === 5) {
        newFontSize = '14px';  // Smaller
      } else if (numberOfLines === 6) {
        newFontSize = '12px';  // Even smaller
      } else {
        newFontSize = '10px';  // Very small but readable
      }

      // Set the custom property and add the class
      treeNameElement.style.setProperty('--js-font-size', newFontSize);
      treeNameElement.classList.add('js-resized');
      treeNameElement.style.setProperty('line-height', '1.1', 'important');
      treeNameElement.style.setProperty('font-weight', '600', 'important');

      console.log(`Adjusted tree name to: ${newFontSize}`);

      // Check again after adjustment
      setTimeout(() => {
        const newHeight = treeNameElement.offsetHeight;
        const newComputedStyle = window.getComputedStyle(treeNameElement);
        const newLineHeight = parseFloat(newComputedStyle.lineHeight);
        const newFontSize = parseFloat(newComputedStyle.fontSize);
        const newLines = Math.round(newHeight / newLineHeight);
        console.log(`After adjustment: ${newLines} lines (height: ${newHeight}, lineHeight: ${newLineHeight}, fontSize: ${newFontSize})`);
      }, 50);
    } else {
      console.log('Tree name fits in 3 lines or less, no adjustment needed');
    }
  }

  // Run when DOM is loaded
  document.addEventListener('DOMContentLoaded', function () {
    console.log('DOM loaded, adjusting tree name...');
    setTimeout(adjustTreeNameFontSize, 500); // Increased delay
  });

  // Also run when window is resized
  window.addEventListener('resize', function () {
    console.log('Window resized, adjusting tree name...');
    setTimeout(adjustTreeNameFontSize, 500);
  });
</script>

{% endblock %}