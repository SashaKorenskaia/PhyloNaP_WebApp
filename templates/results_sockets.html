{% extends "base.html" %}
{% block content %}
<head>
    <title>Waiting Room</title>
    <script src="https://cdn.socket.io/4.2.0/socket.io.min.js"></script>
    <style>
        #updates {
            height: 50vh; /* 50% of the viewport height */
            overflow: auto;
        }
        #results {
            height: 50vh;
        }
        table {
        width: 100%;
        border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
            /* Add a new style for the header */
        header {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 100; /* Make sure the header is always on top */
        }

        /* Add a top padding to the body equal to the height of the header to prevent it from overlapping the content */
        body {
            padding-top: 70px; /* Adjust this value based on the actual height of your header */
        }
        </style>
</head>
<body>
    <h1>Job Submitted</h1>
    <p>Your job has been submitted successfully. You can view the results <a href="{{ url_for('results', job_id=job_id) }}">here</a>.</p>
    <h1 id="job-status"></h1>
    <button id="toggleUpdatesButton" onclick="toggleUpdates()">Hide Updates</button>
    <div id="job-updates"></div>
    <!-- <button id="phylogeneticTreeButton" style="display: none;">Phylogenetic Tree</button> -->
    <div id="results"></div>
</body>
<script>
    let jobId = "{{ job_id }}";
    // let socket = io.connect('http://' + document.domain + ':' + location.port);
    const socket = io();
    let fetchInterval;
    

    // function fetchJobStatus() {
    //     // fetch('/results/' + jobId + '?status=true')
    //     fetch('/results/' + jobId)
    //         .then(response => response.json())
    //         .then(data => {
    //             // Update the page with the job status and updates
    //             document.getElementById('job-status').innerText = data.status;
    //             document.getElementById('job-updates').innerText = data.updates;

    //             // Stop fetching if the job is finished
    //             if (data.status === 'finished') {
    //                 clearInterval(fetchInterval);
    //             }
    //         })
    //         .catch(error => console.error('Error fetching job status:', error));
    // }
    function fetchJobStatus() {
        fetch('/results/' + jobId)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text(); // Get response as text
            })
            .then(text => {
                console.log('Response text:', text); // Log the response text
                let data;
                try {
                    data = JSON.parse(text); // Parse the text as JSON
                } catch (error) {
                    throw new Error('Error parsing JSON: ' + error.message);
                }

                // Update the page with the job status and updates
                document.getElementById('job-status').innerText = data.status;
                document.getElementById('job-updates').innerText = data.updates;

                // Stop fetching if the job is finished
                if (data.status === 'finished') {
                    clearInterval(fetchInterval);
                }
            })
            .catch(error => console.error('Error fetching job status:', error));
    }
    // Fetch job status and updates periodically
    // fetchInterval = setInterval(fetchJobStatus, 5000); // Fetch every 5 seconds

    // Ensure HTML elements exist
    // document.addEventListener('DOMContentLoaded', function() {
    //     if (!document.getElementById('job-status')) {
    //         let jobStatus = document.createElement('h1');
    //         jobStatus.id = 'job-status';
    //         document.body.appendChild(jobStatus);
    //     }
    //     if (!document.getElementById('job-updates')) {
    //         let jobUpdates = document.createElement('div');
    //         jobUpdates.id = 'job-updates';
    //         document.body.appendChild(jobUpdates);
    //     }
    // });

    let socketClosed = false;
    let finished = false;

    socket.on('connect', () => {
        if (!socketClosed) {
            console.log('Connected to server');
            socket.emit('request_status', { job_id: jobId });
        }
        });
    async function fetchJobStatus() {
        // fetch('/results/' + jobId + '?status=true')
        }

    socket.on('status_update', (data) => {
        let n = 0;
        if (!socketClosed) {


            document.getElementById('job-status').innerText = data.status;
            const jobUpdatesElement = document.getElementById('job-updates');
            jobUpdatesElement.innerText += data.updates + '\n';
            n += 1;
            console.log('Received socket update:', n);
          
            };
    });
    socket.on('json_data', (table_data) => {
                data_json=JSON.parse(table_data.row_data_json);
                console.log('Row Data:', data_json);
                createResultsTable(data_json);
            });

    // function createResultsTable(rowDataList) {
    //     // without a sort, display even 0 results
    //     // Create a table
    //     var table = document.createElement('table');

    //     // Create a header row
    //     var headerRow = document.createElement('tr');
    //     ['Query', 'Superfamily', 'Family', 'Like Weight Ratio', 'Pendant Length','The Tree'].forEach(function(header) {
    //         var th = document.createElement('th');
    //         th.textContent = header;
    //         headerRow.appendChild(th);
    //     });
    //     table.appendChild(headerRow);

    //     // Create a row for each dictionary in rowDataList
    //     rowDataList.forEach(function(rowData) {
    //         var row = document.createElement('tr');
    //         ['query', 'superfamily', 'family'].forEach(function(key) {
    //             var td = document.createElement('td');
    //             td.textContent = rowData[key];
    //             row.appendChild(td);
    //         });
    //                 // Fetch and cache the data from the specified files
    //         fetch(`/epa_res/${jobId}/${rowData['query']}/${rowData['tree_id']}`)
    //             .then(response => response.json())
    //             .then(data => {
    //                 var likeWeightRatio = data.like_weight_ratio;
    //                 var pendantLength = data.pendant_length;

    //                 var tdLikeWeightRatio = document.createElement('td');
    //                 tdLikeWeightRatio.textContent = likeWeightRatio;
    //                 row.appendChild(tdLikeWeightRatio);

    //                 var tdPendantLength = document.createElement('td');
    //                 tdPendantLength.textContent = pendantLength;
    //                 row.appendChild(tdPendantLength);

    //                 var button = document.createElement('button');
    //                 button.textContent = 'View .jplace file';
    //                 button.onclick = function() {
    //                     // Redirect to the jplace_render.html page
    //                     window.location.href = '/jplace_render.html?jobId=' + jobId + '&query=' + rowData['query'] + '&treeId=' + rowData['tree_id'];
    //                 };

    //                 // Add the button to the "The Tree" column
    //                 var tdButton = document.createElement('td');
    //                 tdButton.appendChild(button);
    //                 row.appendChild(tdButton);
    //             })
    //             .catch(error => console.error('Error fetching jplace data:', error));

    //         // table.appendChild(row);

    //         // Create a button



    //         // // Add the button to the row
    //         // var td = document.createElement('td');
    //         // td.appendChild(button);
    //         // row.appendChild(td);

    //         table.appendChild(row);
    //     });

    //     // Append the table to the results div
    //     document.getElementById('results').appendChild(table);
    // }

    function createResultsTable(rowDataList) {
        var table = document.createElement('table');

        var headerRow = document.createElement('tr');
        ['Query', 'Superfamily', 'Family', 'Like Weight Ratio', 'Pendant Length', 'The Tree'].forEach(function(header) {
            var th = document.createElement('th');
            th.textContent = header;
            headerRow.appendChild(th);
        });
        table.appendChild(headerRow);

        // Fetch and process all data first
        var promises = rowDataList.map(function(rowData) {
            return fetch(`/epa_res/${jobId}/${rowData['query']}/${rowData['tree_id']}`)
                .then(response => response.json())
                .then(data => {
                    return {
                        ...rowData,
                        like_weight_ratio: data.like_weight_ratio,
                        pendant_length: data.pendant_length
                    };
                })
                .catch(error => {
                    console.error('Error fetching jplace data:', error);
                    return null;
                });
        });

        Promise.all(promises).then(function(results) {
            // Filter out any null results due to errors
            results = results.filter(result => result !== null);

            // Sort by descending Pendant Length value
            //results.sort((a, b) => b.pendant_length - a.pendant_length);

            // Sort by ascending Pendant Length value
            results.sort((a, b) => a.pendant_length - b.pendant_length);

            // Create table rows based on sorted data
            results.forEach(function(rowData) {
                var row = document.createElement('tr');
                ['query', 'superfamily', 'family'].forEach(function(key) {
                    var td = document.createElement('td');
                    td.textContent = rowData[key];
                    row.appendChild(td);
                });

                var tdLikeWeightRatio = document.createElement('td');
                tdLikeWeightRatio.textContent = rowData.like_weight_ratio;
                row.appendChild(tdLikeWeightRatio);

                var tdPendantLength = document.createElement('td');
                tdPendantLength.textContent = rowData.pendant_length;
                row.appendChild(tdPendantLength);

                var button = document.createElement('button');
                button.textContent = 'View .jplace file';
                button.onclick = function() {
                    // Redirect to the jplace_render.html page
                    window.location.href = '/jplace_render.html?jobId=' + jobId + '&query=' + rowData['query'] + '&treeId=' + rowData['tree_id'];
                };

                // Add the button to the "The Tree" column
                var tdButton = document.createElement('td');
                tdButton.appendChild(button);
                row.appendChild(tdButton);

                table.appendChild(row);
            });

            // Append the table to the results div
            document.getElementById('results').appendChild(table);
        });
    }

    function toggleUpdates() {
        var updatesDiv = document.getElementById('job-updates');
        var resultsDiv = document.getElementById('results');
        var toggleButton = document.getElementById('toggleUpdatesButton');

        if (updatesDiv.style.display !== 'none') {
            // Hide the updates and give more space to the results
            updatesDiv.style.display = 'none';
            resultsDiv.style.height = '90vh'; // Adjust this value as needed
            toggleButton.textContent = 'Show Updates';
        } else {
            // Show the updates and reduce the space for the results
            updatesDiv.style.display = 'block';
            resultsDiv.style.height = '50vh'; // Adjust this value as needed
            toggleButton.textContent = 'Hide Updates';
        }
    }
</script>

{% endblock %}