<!-- templates/database.html -->
{% extends "base.html" %}
{% block content %}
<style>
    .selected-superfamily {
        background-color: #B69E6C !important;
        color: black !important;
    }
    .show-button {
        outline: none !important;
    }
    .show-button:focus {
        outline: none !important;
        box-shadow: none !important;
    }
</style>
<form method="post" action="/phylotree_render">
    <!-- Add Filter Dropdown -->
    <div class="d-flex mb-3">
    <div class="mb-3">
        <div class="mb-3">
            <label for="superfamily-filter" class="form-label">Filter by Superfamily</label>
            <select id="superfamily-filter" class="form-select" name="superfamily-filter">
                <option value="">All</option>
                {% for superfamily in superfamilies %}
                <option value="{{ superfamily.name }}">{{ superfamily.name }}</option>
                {% endfor %}
            </select>
        </div>
        <!-- <label for="source-filter">Filter by Source</label>
        <select id="source-filter" multiple>
            {% for superfamily in superfamilies %}
                {% for dataset in superfamily.datasets %}
                    <option value="{{ dataset.source }}">{{ dataset.source }}</option>
                {% endfor %}
            {% endfor %}
        </select> -->
        <div>
            <label for="source-filter">Filter by Source</label>
            <select id="source-filter" multiple class="form-select">
                {% set unique_sources = [] %}
                {% for superfamily in superfamilies %}
                    {% for dataset in superfamily.datasets %}
                        {% if dataset.source not in unique_sources %}
                            {% set unique_sources = unique_sources.append(dataset.source) %}
                        {% endif %}
                    {% endfor %}
                {% endfor %}
                {% for source in unique_sources %}
                <option value="{{ source }}">{{ source }}</option>
                {% endfor %}
            </select>
        </div>
        <button id="show-all-datasets" class="btn btn-secondary mb-3" type="button">Show All Datasets</button>
    </div>

    <!-- Add Show All Datasets Button -->

    <!-- Table to Show All Datasets -->
    <div id="all-datasets-table" style="display: none;">
        <table class="table">
            <thead>
                <tr>
                    <th>Superfamily</th>
                    <th>Dataset Name</th>
                    <th>Source</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for superfamily in superfamilies %}
                    {% for dataset in superfamily.datasets %}
                    <tr data-superfamily="{{ superfamily.name }}">
                        <td>{{ superfamily.name }}</td>
                        <td>{{ dataset.name }}</td>
                        <td>{{ dataset.source }}</td>
                        <td>
                            <input type="hidden" id="tree-file" value="{{ url_for('get_file', filename=dataset.tree) }}">
                            <input type="hidden" id="metadata-file" value="{{ url_for('get_file', filename=dataset.metadata) }}">
                            <input type="hidden" id="column_list" value="{{ dataset.metadata_columns }}">
                            <button class="btn btn-primary show-button m-1" type="button"
                            style="background-color: #a61e37; color: white;" 
                            data-superfamily="{{ superfamily.name }}" data-dataset="{{ dataset.name }}">Show Tree</button>
                        </td>
                    </tr>
                    {% endfor %}
                {% endfor %}
            </tbody>
        </table>
    </div>
</form>

<div id="tree"></div>

<!-- <script>
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('show-all-datasets').addEventListener('click', function() {
            document.getElementById('all-datasets-table').style.display = 'block';
        });

        document.getElementById('superfamily-filter').addEventListener('change', function() {
            var filterValue = this.value.toLowerCase();
            var rows = document.querySelectorAll('#all-datasets-table tbody tr');
            rows.forEach(function(row) {
                var superfamily = row.getAttribute('data-superfamily').toLowerCase();
                if (filterValue === "" || superfamily === filterValue) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    });
</script> -->

<script>
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.show-button').forEach(function(button) {
            button.addEventListener('click', function() {
                var superfamilyName = button.getAttribute('data-superfamily');
                var datasetName = button.getAttribute('data-dataset');
                window.location.href = '/phylotree_render?superfamily=' + encodeURIComponent(superfamilyName) 
                + '&dataset=' + encodeURIComponent(datasetName);
            });
        });

        document.getElementById('show-all-datasets').addEventListener('click', function() {
            document.getElementById('superfamily-filter').value = "";
            document.getElementById('source-filter').selectedIndex = -1;
            document.getElementById('all-datasets-table').style.display = 'block';
            filterTable();
        });

        function filterTable() {
            var selectedSuperfamily = document.getElementById('superfamily-filter').value.toLowerCase();
            var selectedSources = Array.from(document.getElementById('source-filter').selectedOptions).map(option => option.value.toLowerCase());
            var rows = document.querySelectorAll('#all-datasets-table tbody tr');
            rows.forEach(function(row) {
                var superfamily = row.getAttribute('data-superfamily').toLowerCase();
                var source = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
                var showRow = (selectedSuperfamily === "" || superfamily === selectedSuperfamily) &&
                              (selectedSources.length === 0 || selectedSources.includes(source));
                row.style.display = showRow ? '' : 'none';
            });
        }

        document.getElementById('superfamily-filter').addEventListener('change', filterTable);
        document.getElementById('source-filter').addEventListener('change', filterTable);
    });
</script>

<!-- <script>
    document.querySelectorAll('.accordion-button').forEach(function(button) {
        button.addEventListener('click', function() {
            document.querySelectorAll('.accordion-button').forEach(function(btn) {
                btn.classList.remove('selected-superfamily');
            });
            button.classList.add('selected-superfamily');
        });
    });
</script> -->
<!-- <script>
    document.querySelectorAll('.show-button').forEach(function(button) {
        button.addEventListener('click', function() {
            var superfamilyName = button.getAttribute('data-superfamily');
            var datasetName = button.getAttribute('data-dataset');
            window.location.href = '/phylotree_render?superfamily=' + encodeURIComponent(superfamilyName) 
            + '&dataset=' + encodeURIComponent(datasetName);
        });
    });
</script> -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>

{% endblock %}