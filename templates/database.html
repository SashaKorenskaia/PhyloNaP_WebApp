<!-- templates/database.html -->
{% extends "base.html" %}
{% block content %}
<style>
    .selected-superfamily {
        background-color: #B69E6C !important;
        color: black !important;
    }
    .show-button {
        outline: none !important;
    }
    .show-button:focus {
        outline: none !important;
        box-shadow: none !important;
    }
    .fixed-table {
        width: 100%;
    }
    .fixed-table th, .fixed-table td {
        word-wrap: break-word;
        max-width: 200px;
    }
    .filter-section {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .filter-row {
        margin-bottom: 15px;
    }
    .stats-info {
        font-size: 0.9em;
        color: #6c757d;
        margin-top: 5px;
    }
    .pagination-info {
        margin: 10px 0;
        font-size: 0.9em;
        color: #6c757d;
    }
    .loading {
        display: none;
        text-align: center;
        padding: 20px;
    }
    .collapse-toggle {
        cursor: pointer;
        user-select: none;
    }
    .range-input-group {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .range-input-group input {
        width: 80px;
    }
    .sort-controls {
        background-color: #f1f3f4;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    .table-container {
        overflow-x: auto;
    }
    .sortable-header {
        cursor: pointer;
        user-select: none;
    }
    .sortable-header:hover {
        background-color: #e9ecef;
    }
    .sort-icon {
        margin-left: 5px;
        font-size: 0.8em;
    }
    .active-sort {
        background-color: #dee2e6;
    }
    .btn-group-sm .btn {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
</style>

<div class="container-fluid">
    <h1>PhyloNaP Database</h1>
    
    <!-- Results Summary -->
    <div class="alert alert-info" id="results-summary">
        {% if pagination %}
            Showing {{ pagination.page * pagination.per_page - pagination.per_page + 1 }}-{{ pagination.page * pagination.per_page if pagination.page * pagination.per_page < pagination.total_count else pagination.total_count }} 
            of {{ pagination.total_count }} datasets
        {% else %}
            Loading datasets...
        {% endif %}
    </div>
    
    <!-- Advanced Filters Section -->
    <div class="filter-section">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">
                <span class="collapse-toggle" data-bs-toggle="collapse" data-bs-target="#advanced-filters">
                    <i class="fas fa-filter"></i> Advanced Filters
                    <i class="fas fa-chevron-down" id="filter-chevron"></i>
                </span>
            </h4>
            <div>
                <button id="clear-filters" class="btn btn-outline-secondary btn-sm">Clear All</button>
                <button id="apply-filters" class="btn btn-primary btn-sm">Apply Filters</button>
            </div>
        </div>
        
        <div class="collapse show" id="advanced-filters">
            <form id="filter-form">
                <!-- Basic Filters Row -->
                <div class="row filter-row">
                    <div class="col-md-3">
                        <label for="superfamily-filter" class="form-label">Superfamily</label>
                        <select id="superfamily-filter" name="superfamily" class="form-select">
                            <option value="">All Superfamilies</option>
                            {% if filter_options and filter_options.superfamilies %}
                                {% for superfamily in filter_options.superfamilies %}
                                <option value="{{ superfamily }}" 
                                    {% if current_filters and current_filters.superfamily == superfamily %}selected{% endif %}>
                                    {{ superfamily }}
                                </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <label for="source-filter" class="form-label">Source</label>
                        <select id="source-filter" name="source" class="form-select">
                            <option value="">All Sources</option>
                            {% if filter_options and filter_options.sources %}
                                {% for source in filter_options.sources %}
                                <option value="{{ source }}"
                                    {% if current_filters and current_filters.source == source %}selected{% endif %}>
                                    {{ source|title }}
                                </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <label for="data-type-filter" class="form-label">Data Type</label>
                        <select id="data-type-filter" name="data_type" class="form-select">
                            <option value="">All Types</option>
                            {% if filter_options and filter_options.data_types %}
                                {% for data_type in filter_options.data_types %}
                                <option value="{{ data_type }}"
                                    {% if current_filters and current_filters.data_type == data_type %}selected{% endif %}>
                                    {{ data_type|title }}
                                </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <label for="reviewed-filter" class="form-label">Reviewed</label>
                        <select id="reviewed-filter" name="reviewed" class="form-select">
                            <option value="">All</option>
                            {% if filter_options and filter_options.reviewed_options %}
                                {% for reviewed in filter_options.reviewed_options %}
                                <option value="{{ reviewed }}"
                                    {% if current_filters and current_filters.reviewed == reviewed %}selected{% endif %}>
                                    {{ reviewed|title }}
                                </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                </div>
                
                <!-- Search Filters Row -->
                <div class="row filter-row">
                    <div class="col-md-4">
                        <label for="dataset-name-filter" class="form-label">Dataset Name</label>
                        <input type="text" id="dataset-name-filter" name="dataset_name" class="form-control" 
                               placeholder="Search dataset name..."
                               value="{{ current_filters.dataset_name if current_filters and current_filters.dataset_name }}">
                    </div>
                    
                    <div class="col-md-4">
                        <label for="hmm-name-filter" class="form-label">HMM Name</label>
                        <input type="text" id="hmm-name-filter" name="hmm_name" class="form-control" 
                               placeholder="Search HMM name..."
                               value="{{ current_filters.hmm_name if current_filters and current_filters.hmm_name }}">
                        {% if filter_options and filter_options.hmm_names %}
                        <datalist id="hmm-names-list">
                            {% for hmm in filter_options.hmm_names %}
                            <option value="{{ hmm }}">
                            {% endfor %}
                        </datalist>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label">Records per page</label>
                        <select id="per-page-filter" name="per_page" class="form-select">
                            <option value="25" {% if pagination and pagination.per_page == 25 %}selected{% endif %}>25</option>
                            <option value="50" {% if pagination and pagination.per_page == 50 %}selected{% endif %}>50</option>
                            <option value="100" {% if pagination and pagination.per_page == 100 %}selected{% endif %}>100</option>
                            <option value="200" {% if pagination and pagination.per_page == 200 %}selected{% endif %}>200</option>
                        </select>
                    </div>
                </div>
                
                <!-- Numeric Range Filters Row -->
                <div class="row filter-row">
                    <div class="col-md-3">
                        <label class="form-label">Number of Proteins</label>
                        {% if filter_options and filter_options.protein_stats %}
                        <div class="stats-info">Range: {{ filter_options.protein_stats.min }} - {{ filter_options.protein_stats.max|int }}</div>
                        {% endif %}
                        <div class="range-input-group">
                            <input type="number" id="min-proteins" name="min_proteins" class="form-control" 
                                   placeholder="Min" min="0"
                                   value="{{ current_filters.min_proteins if current_filters and current_filters.min_proteins > 0 }}">
                            <span>to</span>
                            <input type="number" id="max-proteins" name="max_proteins" class="form-control" 
                                   placeholder="Max" min="0"
                                   value="{{ current_filters.max_proteins if current_filters and current_filters.max_proteins }}">
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label">Characterized Proteins</label>
                        {% if filter_options and filter_options.characterized_stats %}
                        <div class="stats-info">Range: {{ filter_options.characterized_stats.min }} - {{ filter_options.characterized_stats.max|int }}</div>
                        {% endif %}
                        <div class="range-input-group">
                            <input type="number" id="min-characterized" name="min_characterized" class="form-control" 
                                   placeholder="Min" min="0"
                                   value="{{ current_filters.min_characterized if current_filters and current_filters.min_characterized > 0 }}">
                            <span>to</span>
                            <input type="number" id="max-characterized" name="max_characterized" class="form-control" 
                                   placeholder="Max" min="0"
                                   value="{{ current_filters.max_characterized if current_filters and current_filters.max_characterized }}">
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label">Validated NP</label>
                        {% if filter_options and filter_options.np_val_stats %}
                        <div class="stats-info">Range: {{ filter_options.np_val_stats.min }} - {{ filter_options.np_val_stats.max|int }}</div>
                        {% endif %}
                        <div class="range-input-group">
                            <input type="number" id="min-np-val" name="min_np_val" class="form-control" 
                                   placeholder="Min" min="0"
                                   value="{{ current_filters.min_np_val if current_filters and current_filters.min_np_val > 0 }}">
                            <span>to</span>
                            <input type="number" id="max-np-val" name="max_np_val" class="form-control" 
                                   placeholder="Max" min="0"
                                   value="{{ current_filters.max_np_val if current_filters and current_filters.max_np_val }}">
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label">Predicted NP</label>
                        {% if filter_options and filter_options.np_pred_stats %}
                        <div class="stats-info">Range: {{ filter_options.np_pred_stats.min }} - {{ filter_options.np_pred_stats.max|int }}</div>
                        {% endif %}
                        <div class="range-input-group">
                            <input type="number" id="min-np-pred" name="min_np_pred" class="form-control" 
                                   placeholder="Min" min="0"
                                   value="{{ current_filters.min_np_pred if current_filters and current_filters.min_np_pred > 0 }}">
                            <span>to</span>
                            <input type="number" id="max-np-pred" name="max_np_pred" class="form-control" 
                                   placeholder="Max" min="0"
                                   value="{{ current_filters.max_np_pred if current_filters and current_filters.max_np_pred }}">
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Sorting Controls -->
    <div class="sort-controls">
        <div class="row align-items-center">
            <div class="col-md-4">
                <label for="sort-by" class="form-label">Sort by:</label>
                <select id="sort-by" class="form-select">
                    <option value="superfamily_name" {% if current_sort and current_sort.sort_by == 'superfamily_name' %}selected{% endif %}>Superfamily Name</option>
                    <option value="dataset_name" {% if current_sort and current_sort.sort_by == 'dataset_name' %}selected{% endif %}>Dataset Name</option>
                    <option value="source" {% if current_sort and current_sort.sort_by == 'source' %}selected{% endif %}>Source</option>
                    <option value="data_type" {% if current_sort and current_sort.sort_by == 'data_type' %}selected{% endif %}>Data Type</option>
                    <option value="reviewed" {% if current_sort and current_sort.sort_by == 'reviewed' %}selected{% endif %}>Reviewed Status</option>
                    <option value="N_proteins" {% if current_sort and current_sort.sort_by == 'N_proteins' %}selected{% endif %}>Number of Proteins</option>
                    <option value="N_characterized" {% if current_sort and current_sort.sort_by == 'N_characterized' %}selected{% endif %}>Characterized Proteins</option>
                    <option value="N_np_val" {% if current_sort and current_sort.sort_by == 'N_np_val' %}selected{% endif %}>Validated NP</option>
                    <option value="N_np_pred" {% if current_sort and current_sort.sort_by == 'N_np_pred' %}selected{% endif %}>Predicted NP</option>
                    <option value="created_at" {% if current_sort and current_sort.sort_by == 'created_at' %}selected{% endif %}>Creation Date</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="sort-order" class="form-label">Order:</label>
                <select id="sort-order" class="form-select">
                    <option value="asc" {% if current_sort and current_sort.sort_order == 'asc' %}selected{% endif %}>Ascending</option>
                    <option value="desc" {% if current_sort and current_sort.sort_order == 'desc' %}selected{% endif %}>Descending</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <div>
                    <button id="apply-sort" class="btn btn-primary btn-sm">Apply Sort</button>
                    <button id="reset-sort" class="btn btn-outline-secondary btn-sm">Reset</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Table -->
    <div class="table-container">
        <!-- Loading indicator -->
        <div class="loading-indicator text-center" id="loading-indicator" style="display: none;">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading datasets...</p>
        </div>
        
        <!-- Results summary -->
        <div class="alert alert-info" id="results-summary" style="display: none;">
            Showing <span id="showing-from">0</span>-<span id="showing-to">0</span> 
            of <span id="total-count">0</span> datasets
        </div>
        
        <!-- Table -->
        <table class="table table-striped table-hover fixed-table" id="datasets-table">
            <thead class="table-dark">
                <tr>
                    <th class="sortable-header" data-sort="superfamily_name">
                        Superfamily 
                        <i class="fas fa-sort sort-icon" id="sort-superfamily_name"></i>
                    </th>
                    <th class="sortable-header" data-sort="dataset_name">
                        Dataset Name 
                        <i class="fas fa-sort sort-icon" id="sort-dataset_name"></i>
                    </th>
                    <th class="sortable-header" data-sort="source">
                        Source 
                        <i class="fas fa-sort sort-icon" id="sort-source"></i>
                    </th>
                    <th class="sortable-header" data-sort="data_type">
                        Data Type 
                        <i class="fas fa-sort sort-icon" id="sort-data_type"></i>
                    </th>
                    <th class="sortable-header" data-sort="reviewed">
                        Reviewed 
                        <i class="fas fa-sort sort-icon" id="sort-reviewed"></i>
                    </th>
                    <th class="sortable-header" data-sort="N_proteins">
                        Proteins 
                        <i class="fas fa-sort sort-icon" id="sort-N_proteins"></i>
                    </th>
                    <th class="sortable-header" data-sort="N_characterized">
                        Characterized 
                        <i class="fas fa-sort sort-icon" id="sort-N_characterized"></i>
                    </th>
                    <th class="sortable-header" data-sort="N_np_val">
                        NP Val 
                        <i class="fas fa-sort sort-icon" id="sort-N_np_val"></i>
                    </th>
                    <th class="sortable-header" data-sort="N_np_pred">
                        NP Pred 
                        <i class="fas fa-sort sort-icon" id="sort-N_np_pred"></i>
                    </th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="datasets-tbody">
                <!-- Data will be loaded here via AJAX -->
            </tbody>
        </table>
        
        <!-- Pagination -->
        <nav aria-label="Dataset pagination" id="pagination-nav" style="display: none;">
            <div class="d-flex justify-content-between align-items-center">
                <div class="pagination-info">
                    Page <span id="current-page">1</span> of <span id="total-pages">1</span>
                </div>
                <ul class="pagination" id="pagination-list">
                    <!-- Pagination buttons will be generated here -->
                </ul>
            </div>
        </nav>
    </div>

    <!-- Pagination -->
    {% if pagination and pagination.total_pages > 1 %}
    <nav aria-label="Dataset pagination">
        <div class="d-flex justify-content-between align-items-center">
            <div class="pagination-info">
                Page {{ pagination.page }} of {{ pagination.total_pages }} 
                ({{ pagination.total_count }} total datasets)
            </div>
            <ul class="pagination">
                {% if pagination.has_prev %}
                <li class="page-item">
                    <a class="page-link" href="#" data-page="1">First</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="#" data-page="{{ pagination.page - 1 }}">Previous</a>
                </li>
                {% endif %}
                
                {% for page_num in range(1, pagination.total_pages + 1) %}
                    {% if page_num == pagination.page %}
                    <li class="page-item active">
                        <span class="page-link">{{ page_num }}</span>
                    </li>
                    {% elif page_num <= 3 or page_num > pagination.total_pages - 3 or (page_num >= pagination.page - 2 and page_num <= pagination.page + 2) %}
                    <li class="page-item">
                        <a class="page-link" href="#" data-page="{{ page_num }}">{{ page_num }}</a>
                    </li>
                    {% elif page_num == 4 or page_num == pagination.total_pages - 3 %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                    {% endif %}
                {% endfor %}
                
                {% if pagination.has_next %}
                <li class="page-item">
                    <a class="page-link" href="#" data-page="{{ pagination.page + 1 }}">Next</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="#" data-page="{{ pagination.total_pages }}">Last</a>
                </li>
                {% endif %}
            </ul>
        </div>
    </nav>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentPage = 1;
    let currentPerPage = 25;
    let currentFilters = {};
    let currentSort = { sort_by: 'superfamily_name', sort_order: 'asc' };
    
    // Load initial data
    loadData();
    
    function loadData(page = 1, resetPage = false) {
        if (resetPage) {
            page = 1;
            currentPage = 1;
        }
        
        showLoading(true);
        
        // Build query parameters
        const params = new URLSearchParams({
            page: page,
            per_page: currentPerPage,
            ...currentFilters,
            ...currentSort
        });
        
        // Remove empty parameters
        for (let [key, value] of Array.from(params.entries())) {
            if (!value || value === '0' || value === '') {
                params.delete(key);
            }
        }
        
        fetch(`/api/datasets?${params.toString()}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                updateTable(data.datasets);
                updatePagination(data.pagination);
                updateSummary(data.pagination);
                currentPage = data.pagination.page;
                
                showLoading(false);
            })
            .catch(error => {
                console.error('Error loading data:', error);
                showError('Failed to load data: ' + error.message);
                showLoading(false);
            });
    }
    
    function updateTable(datasets) {
        const tbody = document.getElementById('datasets-tbody');
        tbody.innerHTML = '';
        
        if (datasets.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" class="text-center">No datasets found matching your criteria.</td></tr>';
            return;
        }
        
        datasets.forEach(dataset => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${dataset.superfamily_name || 'N/A'}</td>
                <td>${dataset.name || dataset.dataset_name || 'N/A'}</td>
                <td>${dataset.source ? dataset.source.charAt(0).toUpperCase() + dataset.source.slice(1) : 'N/A'}</td>
                <td>${dataset.data_type ? dataset.data_type.charAt(0).toUpperCase() + dataset.data_type.slice(1) : 'N/A'}</td>
                <td>
                    <span class="badge ${dataset.reviewed === 'yes' ? 'bg-success' : 'bg-secondary'}">
                        ${dataset.reviewed ? dataset.reviewed.charAt(0).toUpperCase() + dataset.reviewed.slice(1) : 'No'}
                    </span>
                </td>
                <td>${dataset.N_proteins || 0}</td>
                <td>${dataset.N_characterized || 0}</td>
                <td>${dataset.N_np_val || 0}</td>
                <td>${dataset.N_np_pred || 0}</td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-primary show-tree-btn" 
                                data-superfamily="${dataset.superfamily_name}" 
                                data-dataset="${dataset.name || dataset.dataset_name}"
                                title="View Phylogenetic Tree">
                            <i class="fas fa-tree"></i> Tree
                        </button>
                        <button class="btn btn-info view-details-btn"
                                data-dataset-id="${dataset.id || ''}"
                                title="View Dataset Details">
                            <i class="fas fa-info-circle"></i> Details
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
        
        // Re-attach event listeners for new buttons
        attachTableEventListeners();
    }
    
    function updatePagination(pagination) {
        const nav = document.getElementById('pagination-nav');
        const list = document.getElementById('pagination-list');
        
        if (pagination.total_pages <= 1) {
            nav.style.display = 'none';
            return;
        }
        
        nav.style.display = 'block';
        document.getElementById('current-page').textContent = pagination.page;
        document.getElementById('total-pages').textContent = pagination.total_pages;
        
        list.innerHTML = '';
        
        // Previous button
        if (pagination.has_prev) {
            list.innerHTML += `
                <li class="page-item">
                    <a class="page-link" href="#" data-page="1">First</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="#" data-page="${pagination.page - 1}">Previous</a>
                </li>
            `;
        }
        
        // Page numbers
        const start = Math.max(1, pagination.page - 2);
        const end = Math.min(pagination.total_pages, pagination.page + 2);
        
        for (let i = start; i <= end; i++) {
            const activeClass = i === pagination.page ? 'active' : '';
            list.innerHTML += `
                <li class="page-item ${activeClass}">
                    <a class="page-link" href="#" data-page="${i}">${i}</a>
                </li>
            `;
        }
        
        // Next button
        if (pagination.has_next) {
            list.innerHTML += `
                <li class="page-item">
                    <a class="page-link" href="#" data-page="${pagination.page + 1}">Next</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="#" data-page="${pagination.total_pages}">Last</a>
                </li>
            `;
        }
        
        // Attach pagination event listeners
        list.querySelectorAll('.page-link[data-page]').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const page = parseInt(this.getAttribute('data-page'));
                loadData(page);
            });
        });
    }
    
    function updateSummary(pagination) {
        document.getElementById('showing-from').textContent = pagination.showing_from;
        document.getElementById('showing-to').textContent = pagination.showing_to;
        document.getElementById('total-count').textContent = pagination.total_count;
        document.getElementById('results-summary').style.display = 'block';
    }
    
    function showLoading(show) {
        const loading = document.getElementById('loading-indicator');
        const table = document.getElementById('datasets-table');
        
        if (show) {
            loading.style.display = 'block';
            table.style.opacity = '0.5';
        } else {
            loading.style.display = 'none';
            table.style.opacity = '1';
        }
    }
    
    function showError(message) {
        // Create or update error message
        let errorDiv = document.getElementById('error-message');
        if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.id = 'error-message';
            errorDiv.className = 'alert alert-danger';
            document.getElementById('datasets-table').parentNode.insertBefore(errorDiv, document.getElementById('datasets-table'));
        }
        errorDiv.innerHTML = `<strong>Error:</strong> ${message}`;
        errorDiv.style.display = 'block';
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
        }, 5000);
    }
    
    function applyFilters() {
        // Collect filter values
        currentFilters = {
            superfamily: document.getElementById('superfamily-filter').value,
            source: document.getElementById('source-filter').value,
            data_type: document.getElementById('data-type-filter').value,
            reviewed: document.getElementById('reviewed-filter').value,
            dataset_name: document.getElementById('dataset-name-filter').value,
            hmm_name: document.getElementById('hmm-name-filter').value,
            min_proteins: document.getElementById('min-proteins').value,
            max_proteins: document.getElementById('max-proteins').value,
            min_characterized: document.getElementById('min-characterized').value,
            max_characterized: document.getElementById('max-characterized').value,
            min_np_val: document.getElementById('min-np-val').value,
            max_np_val: document.getElementById('max-np-val').value,
            min_np_pred: document.getElementById('min-np-pred').value,
            max_np_pred: document.getElementById('max-np-pred').value,
        };
        
        // Remove empty values
        Object.keys(currentFilters).forEach(key => {
            if (!currentFilters[key] || currentFilters[key] === '0') {
                delete currentFilters[key];
            }
        });
        
        loadData(1, true); // Reset to first page
    }
    
    function applySort() {
        currentSort = {
            sort_by: document.getElementById('sort-by').value,
            sort_order: document.getElementById('sort-order').value
        };
        
        loadData(currentPage);
    }
    
    function attachTableEventListeners() {
        // Tree view buttons
        document.querySelectorAll('.show-tree-btn').forEach(button => {
            button.addEventListener('click', function() {
                const superfamilyName = this.getAttribute('data-superfamily');
                const datasetName = this.getAttribute('data-dataset');
                
                if (superfamilyName && datasetName) {
                    window.location.href = `/phylotree_render?superfamily=${encodeURIComponent(superfamilyName)}&dataset=${encodeURIComponent(datasetName)}`;
                } else {
                    alert('Dataset information is incomplete.');
                }
            });
        });
        
        // Detail view buttons
        document.querySelectorAll('.view-details-btn').forEach(button => {
            button.addEventListener('click', function() {
                const datasetId = this.getAttribute('data-dataset-id');
                alert('Dataset details functionality to be implemented for ID: ' + datasetId);
            });
        });
    }
    
    // Event listeners
    document.getElementById('apply-filters').addEventListener('click', applyFilters);
    document.getElementById('apply-sort').addEventListener('click', applySort);
    
    // Clear filters
    document.getElementById('clear-filters').addEventListener('click', function() {
        document.getElementById('filter-form').reset();
        currentFilters = {};
        currentSort = { sort_by: 'superfamily_name', sort_order: 'asc' };
        document.getElementById('sort-by').value = 'superfamily_name';
        document.getElementById('sort-order').value = 'asc';
        loadData(1, true);
    });
    
    // Per-page selection
    document.getElementById('per-page-filter').addEventListener('change', function() {
        currentPerPage = parseInt(this.value);
        loadData(1, true);
    });
    
    // Sortable headers
    document.querySelectorAll('.sortable-header').forEach(header => {
        header.addEventListener('click', function() {
            const sortField = this.getAttribute('data-sort');
            
            if (currentSort.sort_by === sortField) {
                currentSort.sort_order = currentSort.sort_order === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.sort_by = sortField;
                currentSort.sort_order = 'asc';
            }
            
            document.getElementById('sort-by').value = currentSort.sort_by;
            document.getElementById('sort-order').value = currentSort.sort_order;
            
            loadData(currentPage);
        });
    });
    
    // Auto-apply filters on Enter key
    document.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => {
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                applyFilters();
            }
        });
    });
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>
{% endblock %}