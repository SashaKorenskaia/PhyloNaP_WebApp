<!-- templates/database.html -->
{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='js/overall.css') }}">

<div class="container-fluid">
    
    <!-- Advanced Filters Section -->
    <div class="filter-section">

        <div class="collapse show" id="advanced-filters">
            <form id="filter-form">
                <!-- Basic Filters Row -->
                <div class="row filter-row">
                    <div class="col-md-4">
                        <label for="hmm-name-filter" class="form-label">HMM Name</label>
                        <div class="input-group">
                            <input type="text" 
                                   id="hmm-name-filter" 
                                   name="hmm_name"
                                   class="form-control" 
                                   placeholder="Search or select HMM name..."
                                   autocomplete="off"
                                   value="{{ current_filters.hmm_name if current_filters and current_filters.hmm_name }}">
                            <button class="btn btn-outline-secondary" type="button" id="hmm-dropdown-toggle">
                                â–¼
                            </button>
                        </div>
                        
                        <!-- Keep only the custom dropdown container -->
                        <div id="hmm-dropdown" class="autocomplete-dropdown" style="display: none;"></div>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="source-filter" class="form-label">Source</label>
                        <select id="source-filter" name="source" class="form-select">
                            <option value="">All Sources</option>
                            {% if filter_options and filter_options.sources %}
                                {% for source in filter_options.sources %}
                                <option value="{{ source }}"
                                    {% if current_filters and current_filters.source == source %}selected{% endif %}>
                                    {{ source|title }}
                                </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="data-type-filter" class="form-label">Data Type</label>
                        <select id="data-type-filter" name="data_type" class="form-select">
                            <option value="">All Types</option>
                            {% if filter_options and filter_options.data_types %}
                                {% for data_type in filter_options.data_types %}
                                <option value="{{ data_type }}"
                                    {% if current_filters and current_filters.data_type == data_type %}selected{% endif %}>
                                    {{ data_type|title }}
                                </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                </div>
                
                <!-- Search Filters Row -->
                <div class="row filter-row">
                    <div class="col-md-4">
                        <label for="dataset-name-filter" class="form-label">Dataset Name</label>
                        <input type="text" id="dataset-name-filter" name="dataset_name" class="form-control" 
                               placeholder="Search dataset name..."
                               value="{{ current_filters.dataset_name if current_filters and current_filters.dataset_name }}">
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label">Records per page</label>
                        <select id="per-page-filter" name="per_page" class="form-select">
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                            <option value="200">200</option>
                        </select>
                    </div>
                </div>
                
                <!-- Numeric Range Filters Row -->
                <div class="row filter-row">
                    <div class="col-md-3">
                        <label class="form-label">Number of Proteins</label>
                        {% if filter_options and filter_options.protein_stats %}
                        <div class="stats-info">Range: {{ filter_options.protein_stats.min }} - {{ filter_options.protein_stats.max|int }}</div>
                        {% endif %}
                        <div class="range-input-group">
                            <input type="number" id="min-proteins" name="min_proteins" class="form-control" 
                                   placeholder="Min" min="0"
                                   value="{{ current_filters.min_proteins if current_filters and current_filters.min_proteins > 0 }}">
                            <span>to</span>
                            <input type="number" id="max-proteins" name="max_proteins" class="form-control" 
                                   placeholder="Max" min="0"
                                   value="{{ current_filters.max_proteins if current_filters and current_filters.max_proteins }}">
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label">Characterized Proteins</label>
                        {% if filter_options and filter_options.characterized_stats %}
                        <div class="stats-info">Range: {{ filter_options.characterized_stats.min }} - {{ filter_options.characterized_stats.max|int }}</div>
                        {% endif %}
                        <div class="range-input-group">
                            <input type="number" id="min-characterized" name="min_characterized" class="form-control" 
                                   placeholder="Min" min="0"
                                   value="{{ current_filters.min_characterized if current_filters and current_filters.min_characterized > 0 }}">
                            <span>to</span>
                            <input type="number" id="max-characterized" name="max_characterized" class="form-control" 
                                   placeholder="Max" min="0"
                                   value="{{ current_filters.max_characterized if current_filters and current_filters.max_characterized }}">
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label">Validated NP</label>
                        {% if filter_options and filter_options.np_val_stats %}
                        <div class="stats-info">Range: {{ filter_options.np_val_stats.min }} - {{ filter_options.np_val_stats.max|int }}</div>
                        {% endif %}
                        <div class="range-input-group">
                            <input type="number" id="min-np-val" name="min_np_val" class="form-control" 
                                   placeholder="Min" min="0"
                                   value="{{ current_filters.min_np_val if current_filters and current_filters.min_np_val > 0 }}">
                            <span>to</span>
                            <input type="number" id="max-np-val" name="max_np_val" class="form-control" 
                                   placeholder="Max" min="0"
                                   value="{{ current_filters.max_np_val if current_filters and current_filters.max_np_val }}">
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label">Predicted NP</label>
                        {% if filter_options and filter_options.np_pred_stats %}
                        <div class="stats-info">Range: {{ filter_options.np_pred_stats.min }} - {{ filter_options.np_pred_stats.max|int }}</div>
                        {% endif %}
                        <div class="range-input-group">
                            <input type="number" id="min-np-pred" name="min_np_pred" class="form-control" 
                                   placeholder="Min" min="0"
                                   value="{{ current_filters.min_np_pred if current_filters and current_filters.min_np_pred > 0 }}">
                            <span>to</span>
                            <input type="number" id="max-np-pred" name="max_np_pred" class="form-control" 
                                   placeholder="Max" min="0"
                                   value="{{ current_filters.max_np_pred if current_filters and current_filters.max_np_pred }}">
                        </div>
                    </div>
                </div>
                
                <!-- Apply Filters Button Row - MOVED TO BOTTOM -->
                <div class="row filter-row">
                    <div class="col-12 text-center">
                        <button id="clear-filters" class="btn btn-outline-secondary btn-sm">Clear All</button>
                        <button id="apply-filters" class="btn btn-bright btn-lg">Apply Filters</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Results Table -->
    <div class="table-container">
        <!-- Results summary -->
        <div class="alert alert-info" id="results-summary" style="display: none;">
            Showing <span id="showing-from">0</span>-<span id="showing-to">0</span> 
            of <span id="total-count">0</span> datasets
        </div>
        
        <!-- Table -->
        <table class="table table-striped table-hover fixed-table" id="datasets-table">
            <thead class="table-dark">
                <tr>
                    <th class="sortable-header" data-sort="superfamily_name">
                        Superfamily 
                        <span class="sort-arrows">
                            <span class="sort-up">â–²</span>
                            <span class="sort-down">â–¼</span>
                        </span>
                    </th>
                    <th class="sortable-header" data-sort="dataset_name">
                        Dataset Name 
                        <span class="sort-arrows">
                            <span class="sort-up">â–²</span>
                            <span class="sort-down">â–¼</span>
                        </span>
                    </th>
                    <th class="sortable-header" data-sort="source">
                        Source 
                        <span class="sort-arrows">
                            <span class="sort-up">â–²</span>
                            <span class="sort-down">â–¼</span>
                        </span>
                    </th>
                    <th class="sortable-header" data-sort="data_type">
                        Data Type 
                        <span class="sort-arrows">
                            <span class="sort-up">â–²</span>
                            <span class="sort-down">â–¼</span>
                        </span>
                    </th>
                    <th class="sortable-header" data-sort="N_proteins">
                        Proteins 
                        <span class="sort-arrows">
                            <span class="sort-up">â–²</span>
                            <span class="sort-down">â–¼</span>
                        </span>
                    </th>
                    <th class="sortable-header" data-sort="N_characterized">
                        Characterized 
                        <span class="sort-arrows">
                            <span class="sort-up">â–²</span>
                            <span class="sort-down">â–¼</span>
                        </span>
                    </th>
                    <th class="sortable-header" data-sort="N_np_val">
                        NP Val 
                        <span class="sort-arrows">
                            <span class="sort-up">â–²</span>
                            <span class="sort-down">â–¼</span>
                        </span>
                    </th>
                    <th class="sortable-header" data-sort="N_np_pred">
                        NP Pred 
                        <span class="sort-arrows">
                            <span class="sort-up">â–²</span>
                            <span class="sort-down">â–¼</span>
                        </span>
                    </th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="datasets-tbody">
                <!-- Data will be loaded here via AJAX -->
            </tbody>
        </table>
        
        <!-- Pagination -->
        <nav aria-label="Dataset pagination" id="pagination-nav" style="display: none;">
            <div class="d-flex justify-content-between align-items-center">
                <div class="pagination-info">
                    Page <span id="current-page">1</span> of <span id="total-pages">1</span>
                </div>
                <ul class="pagination" id="pagination-list">
                    <!-- Pagination buttons will be generated here -->
                </ul>
            </div>
        </nav>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentPage = 1;
    let currentPerPage = 25;
    let currentFilters = {};
    let currentSort = { sort_by: 'superfamily_name', sort_order: 'asc' };
    
    // Load initial data
    loadData();
    
    function loadData(page = 1, resetPage = false) {
        if (resetPage) {
            page = 1;
            currentPage = 1;
        }
        
        // Build query parameters
        const params = new URLSearchParams({
            page: page,
            per_page: currentPerPage,
            ...currentFilters,
            ...currentSort
        });
        
        // Remove empty parameters
        for (let [key, value] of Array.from(params.entries())) {
            if (!value || value === '0' || value === '') {
                params.delete(key);
            }
        }
        
        fetch(`/api/datasets?${params.toString()}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                updateTable(data.datasets);
                updatePagination(data.pagination);
                updateSummary(data.pagination);
                updateSortIndicators(); // Update visual sort indicators
                currentPage = data.pagination.page;
            })
            .catch(error => {
                console.error('Error loading data:', error);
                showError('Failed to load data: ' + error.message);
            });
    }
    
    function updateTable(datasets) {
        const tbody = document.getElementById('datasets-tbody');
        tbody.innerHTML = '';
        
        if (datasets.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="text-center">No datasets found matching your criteria.</td></tr>';
            return;
        }
        
        datasets.forEach((dataset, index) => {
            const row = document.createElement('tr');
            
            const superfamilyName = dataset.superfamily_name || 'N/A';
            const datasetName = dataset.name || dataset.dataset_name || 'N/A';
            const datasetId = dataset.id || dataset.dataset_id || null;
            
            row.innerHTML = `
                <td>${superfamilyName}</td>
                <td>${datasetName}</td>
                <td>${dataset.source ? dataset.source.charAt(0).toUpperCase() + dataset.source.slice(1) : 'N/A'}</td>
                <td>${dataset.data_type ? dataset.data_type.charAt(0).toUpperCase() + dataset.data_type.slice(1) : 'N/A'}</td>
                <td>${dataset.N_proteins || 0}</td>
                <td>${dataset.N_characterized || 0}</td>
                <td>${dataset.N_np_val || 0}</td>
                <td>${dataset.N_np_pred || 0}</td>
                <td>
                    <button class="btn btn-bright btn-sm show-tree-btn" 
                            data-dataset-id="${datasetId}"
                            data-superfamily="${superfamilyName}" 
                            data-dataset="${datasetName}"
                            title="View Phylogenetic Tree"
                            ${!datasetId ? 'disabled' : ''}>
                        Tree
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
        
        // Re-attach event listeners for new buttons
        attachTableEventListeners();
        
        console.log('Table updated with', datasets.length, 'datasets. Event listeners attached.');
    }
    
    function updateSortIndicators() {
        // Reset all sort indicators
        document.querySelectorAll('.sort-arrows').forEach(arrows => {
            arrows.classList.remove('active-asc', 'active-desc');
        });
        
        // Find the active sort column and update its indicator
        const activeHeader = document.querySelector(`[data-sort="${currentSort.sort_by}"]`);
        if (activeHeader) {
            const arrows = activeHeader.querySelector('.sort-arrows');
            if (arrows) {
                if (currentSort.sort_order === 'asc') {
                    arrows.classList.add('active-asc');
                } else {
                    arrows.classList.add('active-desc');
                }
            }
        }
    }
    
    function updatePagination(pagination) {
        const nav = document.getElementById('pagination-nav');
        const list = document.getElementById('pagination-list');
        
        if (pagination.total_pages <= 1) {
            nav.style.display = 'none';
            return;
        }
        
        nav.style.display = 'block';
        document.getElementById('current-page').textContent = pagination.page;
        document.getElementById('total-pages').textContent = pagination.total_pages;
        
        list.innerHTML = '';
        
        // Previous button
        if (pagination.has_prev) {
            list.innerHTML += `
                <li class="page-item">
                    <a class="page-link" href="#" data-page="1">First</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="#" data-page="${pagination.page - 1}">Previous</a>
                </li>
            `;
        }
        
        // Page numbers
        const start = Math.max(1, pagination.page - 2);
        const end = Math.min(pagination.total_pages, pagination.page + 2);
        
        for (let i = start; i <= end; i++) {
            const activeClass = i === pagination.page ? 'active' : '';
            list.innerHTML += `
                <li class="page-item ${activeClass}">
                    <a class="page-link" href="#" data-page="${i}">${i}</a>
                </li>
            `;
        }
        
        // Next button
        if (pagination.has_next) {
            list.innerHTML += `
                <li class="page-item">
                    <a class="page-link" href="#" data-page="${pagination.page + 1}">Next</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="#" data-page="${pagination.total_pages}">Last</a>
                </li>
            `;
        }
        
        // Attach pagination event listeners
        list.querySelectorAll('.page-link[data-page]').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const page = parseInt(this.getAttribute('data-page'));
                loadData(page);
            });
        });
    }
    
    function updateSummary(pagination) {
        document.getElementById('showing-from').textContent = pagination.showing_from;
        document.getElementById('showing-to').textContent = pagination.showing_to;
        document.getElementById('total-count').textContent = pagination.total_count;
        document.getElementById('results-summary').style.display = 'block';
    }
    
    function showError(message) {
        let errorDiv = document.getElementById('error-message');
        if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.id = 'error-message';
            errorDiv.className = 'alert alert-danger';
            document.getElementById('datasets-table').parentNode.insertBefore(errorDiv, document.getElementById('datasets-table'));
        }
        errorDiv.innerHTML = `<strong>Error:</strong> ${message}`;
        errorDiv.style.display = 'block';
        
        setTimeout(() => {
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
        }, 5000);
    }
    
    function applyFilters() {
        currentFilters = {
            hmm_name: document.getElementById('hmm-name-filter').value,
            source: document.getElementById('source-filter').value,
            data_type: document.getElementById('data-type-filter').value,
            dataset_name: document.getElementById('dataset-name-filter').value,
            min_proteins: document.getElementById('min-proteins').value,
            max_proteins: document.getElementById('max-proteins').value,
            min_characterized: document.getElementById('min-characterized').value,
            max_characterized: document.getElementById('max-characterized').value,
            min_np_val: document.getElementById('min-np-val').value,
            max_np_val: document.getElementById('max-np-val').value,
            min_np_pred: document.getElementById('min-np-pred').value,
            max_np_pred: document.getElementById('max-np-pred').value,
        };
        
        // Remove empty values
        Object.keys(currentFilters).forEach(key => {
            if (!currentFilters[key] || currentFilters[key] === '0') {
                delete currentFilters[key];
            }
        });
        
        loadData(1, true); // Reset to first page
    }
    
    function attachTableEventListeners() {
        // Tree view buttons
        document.querySelectorAll('.show-tree-btn').forEach(button => {
            button.addEventListener('click', function() {
                const datasetId = this.getAttribute('data-dataset-id');
                const superfamilyName = this.getAttribute('data-superfamily');
                const datasetName = this.getAttribute('data-dataset');
                
                if (datasetId && datasetId !== 'null') {
                    const url = `/phylotree_render?dataset_id=${encodeURIComponent(datasetId)}`;
                    window.location.href = url;
                } else if (superfamilyName && datasetName && superfamilyName !== 'N/A' && datasetName !== 'N/A') {
                    const url = `/phylotree_render?superfamily=${encodeURIComponent(superfamilyName)}&dataset=${encodeURIComponent(datasetName)}`;
                    window.location.href = url;
                } else {
                    alert('Dataset information is incomplete. Please check the data.');
                }
            });
        });
    }
    
    // Event listeners
    document.getElementById('apply-filters').addEventListener('click', applyFilters);
    
    // Clear filters
    document.getElementById('clear-filters').addEventListener('click', function() {
        // Reset the form and filters
        document.getElementById('filter-form').reset();
        document.getElementById('hmm-name-filter').value = '';
        hideDropdown();
        currentFilters = {};
        currentSort = { sort_by: 'superfamily_name', sort_order: 'asc' };
        
        // Reload data without filters
        loadData(1, true);
    });
    
    // Per-page selection
    document.getElementById('per-page-filter').addEventListener('change', function() {
        currentPerPage = parseInt(this.value);
        loadData(1, true);
    });
    
    // Sortable headers - UPDATED LOGIC
    document.querySelectorAll('.sortable-header').forEach(header => {
        header.addEventListener('click', function() {
            const sortField = this.getAttribute('data-sort');
            
            if (currentSort.sort_by === sortField) {
                currentSort.sort_order = currentSort.sort_order === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.sort_by = sortField;
                currentSort.sort_order = 'asc';
            }
            
            loadData(currentPage);
        });
    });
    
    // Auto-apply filters on Enter key
    document.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => {
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                applyFilters();
            }
        });
    });
    
    // HMM Name autocomplete functionality
    let hmmNames = [];
    let currentHighlight = -1;
    const ITEMS_PER_LOAD = 20;
    const INITIAL_LOAD = 10;

    // Load HMM names from filter options
    fetch('/api/filter_options')
        .then(response => response.json())
        .then(data => {
            hmmNames = data.hmm_names || [];
            console.log('HMM names loaded:', hmmNames.length, 'items');
        })
        .catch(error => {
            console.error('Error loading HMM names:', error);
        });

    const hmmInput = document.getElementById('hmm-name-filter');
    const hmmDropdown = document.getElementById('hmm-dropdown');
    let currentFilteredItems = [];
    let currentLoadedCount = 0;

    hmmInput.addEventListener('input', function() {
        const value = this.value.toLowerCase();
        
        if (value === '') {
            // Show first items when input is empty
            currentFilteredItems = hmmNames;
        } else {
            // Filter options based on input
            currentFilteredItems = hmmNames.filter(name => 
                name.toLowerCase().includes(value)
            );
        }
        
        showDropdown(currentFilteredItems, value, true); // Reset view
    });

    hmmInput.addEventListener('focus', function() {
        if (hmmNames.length > 0) {
            const currentValue = this.value.toLowerCase();
            
            if (currentValue) {
                currentFilteredItems = hmmNames.filter(name => 
                    name.toLowerCase().includes(currentValue)
                );
            } else {
                currentFilteredItems = hmmNames;
            }
            
            showDropdown(currentFilteredItems, currentValue, true); // Reset view
        }
    });

    hmmInput.addEventListener('click', function() {
        if (hmmNames.length > 0) {
            const currentValue = this.value.toLowerCase();
            
            if (currentValue) {
                currentFilteredItems = hmmNames.filter(name => 
                    name.toLowerCase().includes(currentValue)
                );
            } else {
                currentFilteredItems = hmmNames;
            }
            
            showDropdown(currentFilteredItems, currentValue, true); // Reset view
        }
    });

    hmmInput.addEventListener('keydown', function(e) {
        const items = hmmDropdown.querySelectorAll('.autocomplete-item');
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            currentHighlight = Math.min(currentHighlight + 1, items.length - 1);
            updateHighlight(items);
            
            // Load more items if we're near the end
            if (currentHighlight >= items.length - 3) {
                loadMoreItems();
            }
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            currentHighlight = Math.max(currentHighlight - 1, -1);
            updateHighlight(items);
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (currentHighlight >= 0 && items[currentHighlight]) {
                const selectedText = items[currentHighlight].getAttribute('data-value') || items[currentHighlight].textContent;
                selectItem(selectedText);
            } else {
                applyFilters();
            }
        } else if (e.key === 'Escape') {
            hideDropdown();
        }
    });

    hmmInput.addEventListener('blur', function(e) {
        setTimeout(() => {
            if (!hmmDropdown.contains(document.activeElement) && !hmmDropdown.matches(':hover')) {
                hideDropdown();
            }
        }, 100);
    });

    // Dropdown toggle button
    const hmmDropdownToggle = document.getElementById('hmm-dropdown-toggle');
    if (hmmDropdownToggle) {
        hmmDropdownToggle.addEventListener('click', function(e) {
            e.preventDefault();
            const input = document.getElementById('hmm-name-filter');
            if (input && hmmNames.length > 0) {
                input.focus();
                const currentValue = input.value.toLowerCase();
                
                if (currentValue) {
                    currentFilteredItems = hmmNames.filter(name => 
                        name.toLowerCase().includes(currentValue)
                    );
                } else {
                    currentFilteredItems = hmmNames;
                }
                
                showDropdown(currentFilteredItems, currentValue, true); // Reset view
            }
        });
    }

    function showDropdown(items, searchValue, resetView = false) {
        if (items.length === 0) {
            hideDropdown();
            return;
        }
        
        if (resetView) {
            currentLoadedCount = 0;
            hmmDropdown.innerHTML = '';
            currentHighlight = -1;
        }
        
        const itemsToShow = Math.min(
            resetView ? INITIAL_LOAD : currentLoadedCount + ITEMS_PER_LOAD,
            items.length
        );
        
        // Add new items
        for (let i = currentLoadedCount; i < itemsToShow; i++) {
            const item = items[i];
            const div = document.createElement('div');
            div.className = 'autocomplete-item';
            div.setAttribute('data-value', item);
            
            // Highlight matching text if there's a search value
            if (searchValue && searchValue.length > 0) {
                const regex = new RegExp(`(${searchValue})`, 'gi');
                const highlightedText = item.replace(regex, '<mark>$1</mark>');
                div.innerHTML = highlightedText;
            } else {
                div.textContent = item;
            }
            
            div.addEventListener('mousedown', function(e) {
                e.preventDefault();
                selectItem(item);
            });
            
            hmmDropdown.appendChild(div);
        }
        
        currentLoadedCount = itemsToShow;
        
        // Add "Load more" indicator if there are more items
        if (currentLoadedCount < items.length) {
            addLoadMoreIndicator();
        } else {
            removeLoadMoreIndicator();
        }
        
        // Add scroll listener for infinite scroll
        addScrollListener();
        
        hmmDropdown.style.display = 'block';
    }

    function loadMoreItems() {
        if (currentLoadedCount >= currentFilteredItems.length) {
            return; // No more items to load
        }
        
        const searchValue = hmmInput.value.toLowerCase();
        const itemsToAdd = Math.min(ITEMS_PER_LOAD, currentFilteredItems.length - currentLoadedCount);
        
        // Add more items
        for (let i = currentLoadedCount; i < currentLoadedCount + itemsToAdd; i++) {
            const item = currentFilteredItems[i];
            const div = document.createElement('div');
            div.className = 'autocomplete-item';
            div.setAttribute('data-value', item);
            
            if (searchValue && searchValue.length > 0) {
                const regex = new RegExp(`(${searchValue})`, 'gi');
                const highlightedText = item.replace(regex, '<mark>$1</mark>');
                div.innerHTML = highlightedText;
            } else {
                div.textContent = item;
            }
            
            div.addEventListener('mousedown', function(e) {
                e.preventDefault();
                selectItem(item);
            });
            
            // Insert before the load more indicator if it exists
            const loadMoreIndicator = hmmDropdown.querySelector('.load-more-indicator');
            if (loadMoreIndicator) {
                hmmDropdown.insertBefore(div, loadMoreIndicator);
            } else {
                hmmDropdown.appendChild(div);
            }
        }
        
        currentLoadedCount += itemsToAdd;
        
        // Update load more indicator
        if (currentLoadedCount >= currentFilteredItems.length) {
            removeLoadMoreIndicator();
        } else {
            updateLoadMoreIndicator();
        }
    }

    function addLoadMoreIndicator() {
        if (hmmDropdown.querySelector('.load-more-indicator')) {
            return; // Already exists
        }
        
        const indicator = document.createElement('div');
        indicator.className = 'load-more-indicator';
        indicator.innerHTML = `
            <div style="padding: 8px 12px; text-align: center; color: #666; font-style: italic; border-top: 1px solid #eee;">
                Showing ${currentLoadedCount} of ${currentFilteredItems.length} items
                <br><small>Scroll down or use arrow keys to load more</small>
            </div>
        `;
        hmmDropdown.appendChild(indicator);
    }

    function updateLoadMoreIndicator() {
        const indicator = hmmDropdown.querySelector('.load-more-indicator');
        if (indicator) {
            indicator.innerHTML = `
                <div style="padding: 8px 12px; text-align: center; color: #666; font-style: italic; border-top: 1px solid #eee;">
                    Showing ${currentLoadedCount} of ${currentFilteredItems.length} items
                    <br><small>Scroll down or use arrow keys to load more</small>
                </div>
            `;
        }
    }

    function removeLoadMoreIndicator() {
        const indicator = hmmDropdown.querySelector('.load-more-indicator');
        if (indicator) {
            indicator.remove();
        }
    }

    function addScrollListener() {
        // Remove existing listener to avoid duplicates
        hmmDropdown.removeEventListener('scroll', handleScroll);
        hmmDropdown.addEventListener('scroll', handleScroll);
    }

    function handleScroll() {
        const dropdown = hmmDropdown;
        const scrollTop = dropdown.scrollTop;
        const scrollHeight = dropdown.scrollHeight;
        const clientHeight = dropdown.clientHeight;
        
        // Load more when near bottom (within 50px)
        if (scrollTop + clientHeight >= scrollHeight - 50) {
            loadMoreItems();
        }
    }

    function hideDropdown() {
        hmmDropdown.style.display = 'none';
        currentHighlight = -1;
        currentLoadedCount = 0;
        // Remove scroll listener
        hmmDropdown.removeEventListener('scroll', handleScroll);
    }

    function updateHighlight(items) {
        items.forEach((item, index) => {
            if (index === currentHighlight) {
                item.classList.add('highlighted');
                // Scroll highlighted item into view
                item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
            } else {
                item.classList.remove('highlighted');
            }
        });
    }

    function selectItem(value) {
        console.log('Selecting HMM item:', value);
        hmmInput.value = value;
        hideDropdown();
    }
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>

<style>
    /* Use CSS variables from overall.css */
    :root {
        --bright-color: var(--bright-color, #7B1B38);
        --background-dark: var(--background-dark, #3D3D3D);
        --background-light: var(--background-light, #E0E0E0);
    }
    
    /* Simple button overrides - no need for complex selectors */
    .btn-bright, .show-tree-btn {
        background-color: var(--bright-color) !important;
        border-color: var(--bright-color) !important;
        color: white !important;
    }
    
    .btn-bright:hover, .show-tree-btn:hover {
        background-color: var(--background-dark) !important;
        border-color: var(--background-dark) !important;
        color: white !important;
    }
    
    /* UPDATE the Apply Filters button styling: */
    #apply-filters {
        background-color: var(--bright-color) !important;
        border-color: var(--bright-color) !important;
        color: white !important;
        font-weight: 600;
        padding: 12px 40px;
        font-size: 1.1rem;
        border-radius: 8px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    #apply-filters:hover {
        background-color: var(--background-dark) !important;
        border-color: var(--background-dark) !important;
        color: white !important;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .selected-superfamily {
        background-color: #B69E6C !important;
        color: black !important;
    }
    
    .show-button {
        outline: none !important;
    }
    
    .show-button:focus {
        outline: none !important;
        box-shadow: none !important;
    }
    
    .fixed-table {
        width: 100%;
    }
    
    .fixed-table th, .fixed-table td {
        word-wrap: break-word;
        max-width: 200px;
    }
    
    .filter-section {
        background-color: var(--background-light);
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
    }
    
    .filter-row {
        margin-bottom: 15px;
    }
    
    .stats-info {
        font-size: 0.9em;
        color: #6c757d;
        margin-top: 5px;
    }
    
    .pagination-info {
        margin: 10px 0;
        font-size: 0.9em;
        color: #6c757d;
    }
    
    .collapse-toggle {
        cursor: pointer;
        user-select: none;
        color: var(--bright-color);
    }
    
    .range-input-group {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .range-input-group input {
        width: 80px;
    }
    
    .sort-controls {
        background-color: var(--background-light);
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
    }
    
    .table-container {
        overflow-x: auto;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* UPDATED: Fix table header visibility with dark background */
    .table-dark {
        --bs-table-bg: var(--background-dark) !important;
        background-color: var(--background-dark) !important;
    }
    
    .table-dark th {
        background-color: var(--background-dark) !important;
        border-color: var(--bright-color) !important;
        color: var(--background-light) !important; /* Light text on dark background */
        font-weight: bold;
        border-bottom: 2px solid var(--bright-color) !important;
    }
    
    .table-dark thead th {
        background-color: var(--background-dark) !important;
        color: var(--background-light) !important;
        border-color: var(--bright-color) !important;
    }
    
    .sortable-header {
        cursor: pointer;
        user-select: none;
        background-color: var(--background-dark) !important;
        color: var(--background-light) !important; /* Light text on dark background */
        position: relative;
    }
    
    .sortable-header:hover {
        background-color: var(--bright-color) !important;
        color: white !important;
    }
    
    .sort-icon {
        margin-left: 5px;
        font-size: 0.8em;
        color: var(--background-light) !important; /* Light colored icons */
    }
    
    .sortable-header:hover .sort-icon {
        color: white !important;
    }
    
    .active-sort {
        background-color: var(--bright-color) !important;
        color: white !important;
    }
    
    .active-sort .sort-icon {
        color: white !important;
    }
    
    .btn-group-sm .btn {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
    
    /* UPDATED: Bright buttons for Tree and Apply Filters - maintain white text */
    .btn-bright {
        background-color: var(--bright-color) !important;
        border-color: var(--bright-color) !important;
        color: white !important;
        font-weight: 500;
    }
    
    .btn-bright:hover {
        background-color: var(--background-dark) !important;
        border-color: var(--background-dark) !important;
        color: white !important;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .btn-bright:focus {
        background-color: var(--bright-color) !important;
        border-color: var(--bright-color) !important;
        color: white !important;
        box-shadow: 0 0 0 0.2rem rgba(123, 27, 56, 0.25) !important;
    }
    
    .btn-bright:active {
        background-color: var(--bright-color) !important;
        border-color: var(--bright-color) !important;
        color: white !important;
    }
    
    /* Tree button specific styling */
    .show-tree-btn {
        background-color: var(--bright-color) !important;
        border-color: var(--bright-color) !important;
        color: white !important;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .show-tree-btn:hover {
        background-color: var(--background-dark) !important;
        border-color: var(--background-dark) !important;
        color: white !important;
        transform: scale(1.05);
    }
    
    .show-tree-btn:focus,
    .show-tree-btn:active {
        background-color: var(--bright-color) !important;
        border-color: var(--bright-color) !important;
        color: white !important;
    }
    
    /* Dark buttons for all other actions */
    .btn-dark {
        background-color: var(--background-dark) !important;
        border-color: var(--background-dark) !important;
        color: white !important;
    }
    
    .btn-dark:hover {
        background-color: var(--bright-color) !important;
        border-color: var(--bright-color) !important;
        color: white !important;
    }
    
    .btn-dark:focus {
        background-color: var(--background-dark) !important;
        border-color: var(--background-dark) !important;
        color: white !important;
        box-shadow: 0 0 0 0.2rem rgba(61, 61, 61, 0.25) !important;
    }
    
    /* Override default button styles */
    .btn-outline-secondary {
        color: var(--background-dark) !important;
        border-color: var(--background-dark) !important;
        background-color: transparent !important;
    }
    
    .btn-outline-secondary:hover {
        background-color: var(--background-dark) !important;
        border-color: var(--background-dark) !important;
        color: white !important;
    }
    
    .alert-info {
        background-color: var(--background-light);
        border-color: var(--bright-color);
        color: var(--background-dark);
    }
    
    h1 {
        color: var(--bright-color);
        margin-bottom: 30px;
    }
    
    h4 {
        color: var(--bright-color);
    }
    
    .table-striped tbody tr:nth-of-type(odd) {
        background-color: rgba(224, 224, 224, 0.3);
    }
    
    .pagination .page-link {
        color: var(--bright-color);
    }
    
    .pagination .page-item.active .page-link {
        background-color: var(--bright-color);
        border-color: var(--bright-color);
        color: white;
    }
    
    .pagination .page-link:hover {
        color: white;
        background-color: var(--background-dark);
        border-color: var(--background-dark);
    }
    
    /* Autocomplete dropdown styling */
    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ccc;
        border-top: none;
        border-radius: 0 0 4px 4px;
        max-height: 300px; /* Increased height */
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .autocomplete-item {
        padding: 10px 12px; /* Slightly more padding */
        cursor: pointer;
        border-bottom: 1px solid #eee;
        transition: background-color 0.2s ease;
    }

    .autocomplete-item:hover,
    .autocomplete-item.highlighted {
        background-color: var(--bright-color);
        color: white;
    }

    .autocomplete-item:last-child {
        border-bottom: none;
    }

    /* Load more indicator styling */
    .load-more-indicator {
        background-color: #f8f9fa;
        border-top: 1px solid #dee2e6;
        font-size: 0.85em;
    }

    .load-more-indicator:hover {
        background-color: #e9ecef;
    }

    /* Improved scrollbar for dropdown */
    .autocomplete-dropdown::-webkit-scrollbar {
        width: 6px;
    }

    .autocomplete-dropdown::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    .autocomplete-dropdown::-webkit-scrollbar-thumb {
        background: var(--bright-color);
        border-radius: 3px;
    }

    .autocomplete-dropdown::-webkit-scrollbar-thumb:hover {
        background: var(--background-dark);
    }

    /* Highlight styling */
    .autocomplete-item mark {
        background-color: #fff3cd;
        color: #856404;
        padding: 1px 2px;
        border-radius: 2px;
    }

    .autocomplete-item:hover mark,
    .autocomplete-item.highlighted mark {
        background-color: rgba(255, 255, 255, 0.3);
        color: white;
    }

    /* Position relative for the input container */
    .col-md-4 {
        position: relative;
    }

    /* Input focus styling */
    #hmm-name-filter:focus {
        border-color: var(--bright-color);
        box-shadow: 0 0 0 0.2rem rgba(123, 27, 56, 0.25);
    }

    /* Add this to your existing styles: */
    .input-group .btn-outline-secondary {
        border-left: 0;
        color: var(--bright-color) !important;
        border-color: #ced4da !important;
    }

    .input-group .btn-outline-secondary:hover {
        background-color: var(--bright-color) !important;
        border-color: var(--bright-color) !important;
        color: white !important;
    }

    .input-group #hmm-name-filter:focus + .btn-outline-secondary {
        border-color: var(--bright-color) !important;
    }
</style>
<link rel="stylesheet" href="{{ url_for('static', filename='js/overall.css') }}">
{% endblock %}