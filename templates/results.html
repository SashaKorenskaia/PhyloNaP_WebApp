{% extends "base.html" %}
{% block content %}
<head>
    <title>Waiting Room</title>
    <!-- Add jQuery before socket.io -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.socket.io/4.2.0/socket.io.min.js"></script>
    <style>
        /* Progress bar styling using CSS variables */
        .progress {
            background-color: var(--background-light, #E0E0E0);
        }
        
        .progress-bar {
            background-color: var(--background-dark, #3D3D3D);
            transition: background-color 0.5s ease;
        }
        
        .progress-bar-complete {
            background-color: var(--bright-color, #7B1B38);
        }
        
        /* Existing styles */
        #updates {
            height: 50vh; /* 50% of the viewport height */
            overflow: auto;
        }
        #results {
            height: 50vh;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        /* Add a new style for the header */
        header {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 100; /* Make sure the header is always on top */
        }

        /* Add a top padding to the body equal to the height of the header to prevent it from overlapping the content */
        body {
            padding-top: 70px; /* Adjust this value based on the actual height of your header */
        }
        .tooltip-header {
            cursor: help;
            text-decoration: underline dotted;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
      <h2>Processing Job: {{ job_id }}</h2>
      
      <div class="card mb-4">
        <div class="card-header">
          Status: <span id="status-text">Pending</span>
        </div>
        <div class="card-body">
          <div class="progress mb-3">
            <div id="progress-bar" class="progress-bar" role="progressbar" 
                 style="width: 0%" aria-valuenow="0" aria-valuemin="0" 
                 aria-valuemax="100">0%</div>
          </div>
          
          <h5>Processing Log:</h5>
          <div id="log-container" class="p-2 bg-light">
            <p>Waiting for processing to begin...</p>
          </div>
        </div>
      </div>
      
      <div id="results-section" style="display:none">
        <div class="card">
          <div class="card-header">
            <h3>Results</h3>
          </div>
          <div class="card-body">
            <table id="results-table" class="table table-striped">
              <thead>
                <tr>
                  <th>Tree ID</th>
                  <th>Family</th>
                  <th>Superfamily</th>
                  <th>Query</th>
                  <th class="tooltip-header" title="Confidence level of placement (1.0 = maximum confidence)">Confidence</th>
                  <th class="tooltip-header" title="Branch length connecting query to the reference tree">Branch Length</th>
                  <th>Description</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <!-- Results will be populated here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
</body>
<script>
  $(document).ready(function() {
    const jobId = "{{ job_id }}";
    let polling;
    
    function updateProgress(progress) {
      // Update the width and text
      $("#progress-bar")
        .css("width", progress + "%")
        .attr("aria-valuenow", progress)
        .text(progress + "%");
      
      // Add color change when complete
      if (progress >= 100) {
        $("#progress-bar").addClass("progress-bar-complete");
      } else {
        $("#progress-bar").removeClass("progress-bar-complete");
      }
    }
    
    function updateStatus(statusData) {
      // Update progress bar
      updateProgress(statusData.progress);
      
      // Update status text
      $("#status-text").text(statusData.status);
      
      // Update log lines
      if (statusData.log_lines && statusData.log_lines.length > 0) {
        const logHtml = statusData.log_lines.map(line => `<p>${line}</p>`).join('');
        $("#log-container").html(logHtml);
      }
      
      // Show results if finished
      if (statusData.status === 'finished') {
        // Stop polling
        clearInterval(polling);
        
        // Show results section
        $("#results-section").show();
        
        // Populate results table if summary exists
        if (statusData.summary) {
          populateResultsTable(statusData.summary);
        }
      }
    }
    
    function populateResultsTable(summary) {
      console.log("Populating table with:", summary);
      
      // Clear existing table
      $("#results-table tbody").empty();
      
      // Check if summary is an array (your actual structure)
      if (Array.isArray(summary)) {
        // Array of results
        summary.forEach(item => {
          // Get query name
          const query = item.query;
          
          // Create row with new fields
          const row = `
            <tr>
              <td>${item.tree_id || "Unknown"}</td>
              <td>${item.family || "Unknown"}</td>
              <td>${item.superfamily || "Unknown"}</td>
              <td>${query}</td>
              <td>${item.like_weight_ratio ? item.like_weight_ratio.toFixed(3) : 'N/A'}</td>
              <td>${item.pendant_length ? item.pendant_length.toFixed(6) : 'N/A'}</td>
              <td>${item.description || 'No description'}</td>
              <td>
                <a href="/jplace_render.html?jobId=${jobId}&query=${query}&treeId=${item.tree_id}" 
                   class="btn btn-primary btn-sm">View</a>
              </td>
            </tr>
          `;
          $("#results-table tbody").append(row);
        });
      } else {
        // Handle any other format (fallback)
        $("#results-table tbody").append('<tr><td colspan="8">Invalid data format</td></tr>');
      }
    }
    
    // Start polling for updates
    polling = setInterval(function() {
      $.ajax({
        url: `/job_status/${jobId}`,
        type: 'GET',
        success: function(data) {
          updateStatus(data);
        },
        error: function(xhr, status, error) {
          console.error("Error fetching job status:", error);
        }
      });
    }, 2000);  // Poll every 2 seconds
  });
</script>

{% endblock %}