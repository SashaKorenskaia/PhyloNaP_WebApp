{% extends "base.html" %}
{% block content %}
<head>
    <title>Waiting Room</title>
    <script src="https://cdn.socket.io/4.2.0/socket.io.min.js"></script>
    <style>
        #updates {
            height: 50vh; /* 50% of the viewport height */
            overflow: auto;
        }
        #results {
            height: 50vh;
        }
        table {
        width: 100%;
        border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
            /* Add a new style for the header */
        header {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 100; /* Make sure the header is always on top */
        }

        /* Add a top padding to the body equal to the height of the header to prevent it from overlapping the content */
        body {
            padding-top: 70px; /* Adjust this value based on the actual height of your header */
        }
        </style>
</head>
<body>
    <h1>Job Submitted</h1>
    <p>Your job has been submitted successfully. You can view the results <a href="{{ url_for('results', job_id=job_id) }}">here</a>.</p>
    <h1 id="job-status"></h1>
    <button id="toggleUpdatesButton" onclick="toggleUpdates()">Hide Updates</button>
    <div id="job-updates"></div>
    <!-- <button id="phylogeneticTreeButton" style="display: none;">Phylogenetic Tree</button> -->
    <div id="results"></div>
</body>
<script>
    let jobId = "{{ job_id }}";
    // let socket = io.connect('http://' + document.domain + ':' + location.port);
    const socket = io();
    let fetchInterval;
    

    // function fetchJobStatus() {
    //     // fetch('/results/' + jobId + '?status=true')
    //     fetch('/results/' + jobId)
    //         .then(response => response.json())
    //         .then(data => {
    //             // Update the page with the job status and updates
    //             document.getElementById('job-status').innerText = data.status;
    //             document.getElementById('job-updates').innerText = data.updates;

    //             // Stop fetching if the job is finished
    //             if (data.status === 'finished') {
    //                 clearInterval(fetchInterval);
    //             }
    //         })
    //         .catch(error => console.error('Error fetching job status:', error));
    // }
    function fetchJobStatus() {
        fetch('/results/' + jobId)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text(); // Get response as text
            })
            .then(text => {
                console.log('Response text:', text); // Log the response text
                let data;
                try {
                    data = JSON.parse(text); // Parse the text as JSON
                } catch (error) {
                    throw new Error('Error parsing JSON: ' + error.message);
                }

                // Update the page with the job status and updates
                document.getElementById('job-status').innerText = data.status;
                document.getElementById('job-updates').innerText = data.updates;

                // Stop fetching if the job is finished
                if (data.status === 'finished') {
                    clearInterval(fetchInterval);
                }
            })
            .catch(error => console.error('Error fetching job status:', error));
    }
    // Fetch job status and updates periodically
    // fetchInterval = setInterval(fetchJobStatus, 5000); // Fetch every 5 seconds

    // Ensure HTML elements exist
    // document.addEventListener('DOMContentLoaded', function() {
    //     if (!document.getElementById('job-status')) {
    //         let jobStatus = document.createElement('h1');
    //         jobStatus.id = 'job-status';
    //         document.body.appendChild(jobStatus);
    //     }
    //     if (!document.getElementById('job-updates')) {
    //         let jobUpdates = document.createElement('div');
    //         jobUpdates.id = 'job-updates';
    //         document.body.appendChild(jobUpdates);
    //     }
    // });
    // document.addEventListener('DOMContentLoaded', function() {
    //     debugger;
    //     fetch('/results/' + jobId)
    //         .then(response => {
    //             if (response.status === 202) {
    //                 // Results not ready yet, show processing message
    //                 document.getElementById('job-status').innerHTML = 'Job ' + jobId + ' is processing';
    //                 return;
    //             }
    //             console.log('Response:', response);
    //             console.log(" Responce content type ", response.headers.get('Content-Type'))
    //             // Parse the JSON data and create a table
    //             response.json().then(rowDataList => {
    //                 document.getElementById('job-status').innerHTML = 'Job ' + jobId + ' has finished';
    //                 createResultsTable(rowDataList);
    //             });
    //         })
    //         .catch(error => console.error('Error fetching job status:', error));
    //             console.error('There was a problem with the fetch operation:', error);
    //         });
    
    socket.on('connect', () => {
        console.log('Connected to server');
        socket.emit('request_status', { job_id: jobId });
        });
    socket.on('status_update', (data) => {
        document.getElementById('job-status').innerText = data.status;
        document.getElementById('job-updates').innerText = data.updates;

        if (data.status === 'finished') {
            fetch('/results/' + jobId)
                // .then(response => response.json())
                .then(rowDataList => {
                    const rowDataJson = JSON.parse('{{ row_data_json | safe }}');
                    debugger;
                    console.log('Row Data:', rowDataJson);
                    createResultsTable(rowDataJson);
                    socket.close();
                })
                .catch(error => console.error('Error fetching job results:', error));
        }
    });
    // socket.on('update', function(msg) {
    //     // Add the update to your page. This example just appends it to a div.
    //     // var message = msg.data.replace(/\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;');
    //     // document.getElementById('updates').innerHTML += '<p>' + message + '</p>';
    //     // // Scroll to the bottom of the updates div
    //     // var updatesDiv = document.getElementById('updates');
    //     // updatesDiv.scrollTop = updatesDiv.scrollHeight;
    //     // if (msg.status === 'running') {
    //     //     document.getElementById('jobStatus').innerHTML = 'Job ' + jobId + ' is running';
    //     // }
    //     // // Check if the job is finished
    //     // if (msg.status === 'finished') {
    //     console.log('Received socket update:', msg);
    //     var updatesDiv = document.getElementById('job-updates');
    //     var newUpdate = document.createElement('p');
    //     newUpdate.textContent = msg.data;
    //     updatesDiv.appendChild(newUpdate);

    //     if (msg.status === 'finished') {
    //         document.getElementById('job-status').innerHTML = 'Job ' + jobId + ' has finished';
    //         // document.getElementById('phylogeneticTreeButton').style.display = 'block';
    //         fetch('/results/' + jobId)
    //             .then(response => {
    //                 // if (response.status === 202) {
    //                 //     // Results not ready yet, try again later
    //                 //     return;
    //                 // }
    //                 if (!response.ok) {
    //                     throw new Error('Network response was not ok');
    //                 }
    //                 return response.json();
    //             })
    //             // Parse the JSON data and create a table
    //             .then(response => response.json())
    //             .then(rowDataList => {
    //                 createResultsTable(rowDataList);
    //                 socket.close();
    //             })
    //             .catch(error => {
    //                 console.error('There was a problem with the fetch operation:', error);
    //             });

    //     }
    // });
    function createResultsTable(rowDataList) {
        // Create a table
        var table = document.createElement('table');

        // Create a header row
        var headerRow = document.createElement('tr');
        ['Query', 'Superfamily', 'Family'].forEach(function(header) {
            var th = document.createElement('th');
            th.textContent = header;
            headerRow.appendChild(th);
        });
        table.appendChild(headerRow);

        // Create a row for each dictionary in rowDataList
        rowDataList.forEach(function(rowData) {
            var row = document.createElement('tr');
            ['query', 'superfamily', 'family'].forEach(function(key) {
                var td = document.createElement('td');
                td.textContent = rowData[key];
                row.appendChild(td);
            });
            table.appendChild(row);

            // Create a button
            var button = document.createElement('button');
            button.textContent = 'View .jplace file';
            button.onclick = function() {
                // Redirect to the jplace_render.html page
                window.location.href = '/jplace_render.html?jobId=' + jobId + '&query=' + rowData['query'] + '&treeId=' + rowData['tree_id'];
            };

            // Add the button to the row
            var td = document.createElement('td');
            td.appendChild(button);
            row.appendChild(td);

            table.appendChild(row);
        });

        // Append the table to the results div
        document.getElementById('results').appendChild(table);
    }

    function toggleUpdates() {
        var updatesDiv = document.getElementById('updates');
        var resultsDiv = document.getElementById('results');
        var toggleButton = document.getElementById('toggleUpdatesButton');

        if (updatesDiv.style.display !== 'none') {
            // Hide the updates and give more space to the results
            updatesDiv.style.display = 'none';
            resultsDiv.style.height = '90vh'; // Adjust this value as needed
            toggleButton.textContent = 'Show Updates';
        } else {
            // Show the updates and reduce the space for the results
            updatesDiv.style.display = 'block';
            resultsDiv.style.height = '50vh'; // Adjust this value as needed
            toggleButton.textContent = 'Hide Updates';
        }
    }
</script>

{% endblock %}